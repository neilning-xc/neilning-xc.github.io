<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="Tell the world with code"/>
    

    <!--Author-->
    
        <meta name="author" content="Neil Ning"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Hooks使用总结和源码解析(一)"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Tell the world with code"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Neil的博客"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

    <!-- Title -->
    
    <title>Hooks使用总结和源码解析(一) - Neil的博客</title>

    <!-- Bootstrap Core CSS -->
    <link href="//lib.baomitu.com/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.css" rel="stylesheet"/>

    <!-- Google Analytics -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPEMLKFYYW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ZPEMLKFYYW');
    </script>



    <!-- favicon -->
    

<meta name="generator" content="Hexo 5.4.2"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Neil的博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                首页
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                归档
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                标签
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                分类
                            
                        </a>
                    </li>
                
                    <li>
                        <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/neilning-xc/neilning-xc.github.io">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header post-header" style="background-image: url('Hooks使用总结和源码解析-一/banner.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Hooks使用总结和源码解析(一)</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Neil Ning on
                        
                        
                            2021-11-21
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/React/">#React</a> <a href="/tags/Hooks/">#Hooks</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/学习/">学习</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Hooks是React16.8的新特性，用于解决函数式组件没有状态的问题，以往的函数式组件是一个纯函数，他的数据只能从父组件中获得，新的特性使得开发者能在函数式组件中编写更加复杂的逻辑，拓展了函数式组件使用场景，使得在函数式组件中复用逻辑变得更加简单。<br>不仅如此，通过React内置的Hooks函数useEffect，开发者还可以组合出class组件不同的生命周期，useEffect的调用方式也使得相似的业务逻辑代码更加紧凑，新版本的React，开发者几乎可以将所有的组件都写成函数式组件。下面对Hooks的相关API做一个整理。</p>
<h2 id="内置Hooks函数"><a href="#内置Hooks函数" class="headerlink" title="内置Hooks函数"></a>内置Hooks函数</h2><h3 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h3><p><code>useState</code>解决了函数式组件没有状态的问题，该函数的参数不仅可以是一个值，还可以是一个函数，函数必须要返回一个值作为默认state的初始值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> initialState = <span class="title function_">someExpensiveComputation</span>(props);</span><br><span class="line">  <span class="keyword">return</span> initialState;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外<code>setState</code>函数的参数也可以是函数，函数的第一个参数是上一个状态值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params">&#123;initialCount&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(initialCount);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      Count: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(initialCount)&#125;&gt;Reset<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(prevCount =&gt; prevCount - 1)&#125;&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(prevCount =&gt; prevCount + 1)&#125;&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码中<code>setCount</code>的参数是一个函数，这在更新后的值依赖于前一个值时很有用。</p>
<p><code>useState</code>以及其他Hooks函数不能在条件，循环，以及嵌套函数内调用，只能在函数组件的顶部作用域调用，组件每次重新渲染，整个函数都相当于重新执行了一次，那<code>useState</code>内部是如何记录上一次的值？为什么Hooks的调用顺序必须一致？</p>
<p>这需要到源码中一探究竟，React源码中，<code>useState</code>在初次渲染时的调用了<code>mountState</code>，更新时调用了<code>updateState</code>，查看打包生成后的react-dom.development.js(或者查看最原始的代码实现react/packages/react/src/ReactHooks.js):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// $FlowFixMe: Flow doesn&#x27;t like mixed types</span></span><br><span class="line">    initialState = <span class="title function_">initialState</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line">  <span class="keyword">var</span> queue = hook.<span class="property">queue</span> = &#123;</span><br><span class="line">    <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">interleaved</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastRenderedReducer</span>: basicStateReducer,</span><br><span class="line">    <span class="attr">lastRenderedState</span>: initialState</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> dispatch = queue.<span class="property">dispatch</span> = dispatchAction.<span class="title function_">bind</span>(<span class="literal">null</span>, currentlyRenderingFiber$1, queue);</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateReducer</span>(basicStateReducer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以<code>mountState</code>为例，函数最终返回hook.memoizedState, dispatch，对应在组件中调用<code>const [state, setState] = useState(0)</code>的返回值，state的值是hook对象的memoizedState属性，dispatch的值是queue.dispatch调用bind后返回的新函数，queue对象也是来自于hook对象上的，看一下hook的生成函数<code>mountWorkInProgressHook</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> hook = &#123;</span><br><span class="line">    <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseQueue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">queue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first hook in the list</span></span><br><span class="line">    currentlyRenderingFiber$1.<span class="property">memoizedState</span> = workInProgressHook = hook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Append to the end of the list</span></span><br><span class="line">    workInProgressHook = workInProgressHook.<span class="property">next</span> = hook;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hook对象上三个关键属性：</p>
<ul>
<li><code>memoizedState</code>记录useState创建的当前state的值</li>
<li><code>queue</code>属性在mountState中被赋值为一个对象</li>
<li><code>next</code>属性说明调用多个useState时会形成一个单向链表</li>
</ul>
<p>该函数中的<code>workInProgressHook</code>变量是遍历单向链表当前节点的指针，第一次调用该函数是他的值为null，然后将它指向第一个hook对象，后续调用则指向hook.next。<br>假设在组件中有如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> [bool, setBool] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>打印<code>workInProgressHook</code>的值，第一次打印：</p>
<p><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/workInProgressHook1.png" alt="workInProgressHook1.png"></p>
<p>第二次打印：<br><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/workInProgressHook2.png" alt="workInProgressHook2.png"><br>所以基本上，Hooks的实现原理是使用单链表加一个外部指针的方式来记录和访问对应state的值，这也是为何react规定hooks必须保证调用顺序一致，不能放在循环或分支语句中的原因。<br><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/useState.png" alt="useState.png"></p>
<h3 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h3><p><code>useEffect</code>也是我们最常使用的Hooks函数之一，其调用也比较简单，它可以允许开发者在回调函数中调用有副作用的函数，比如发送网络请求，操作dom等等。函数的签名为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useEffect</span>(<span class="params">effect: EffectCallback, deps?: DependencyList</span>): <span class="keyword">void</span>;</span><br></pre></td></tr></table></figure>
<p>该函数是class组件中<code>componentDidMount</code>，<code>componentDidUpdate</code>和<code>componentWillUnMount</code>的组合。可以根据deps参数的不同模拟出不同的生命周期函数：</p>
<ul>
<li>不传deps，effect函数将在<code>componentDidMount</code>和<code>componentDidUpdate</code>时执行，即函数每次更新时都会执行</li>
<li>deps为[], effect函数只会在组件<code>componentDidMount</code>时执行一次</li>
<li>deps为[propA, stateB]，函数在<code>componentDidMount</code>执行一次，在由propA或stateB引起的更新后执行一次</li>
<li>effect函数返回一个函数，该函数将在<code>componentWillUnMount</code>时执行一次。</li>
</ul>
<p>和useState类似，useEffect在首次渲染和更新渲染所调用的方法是不同的，并且调用useEffect也会向单向链表中添加一个新的hook对象节点，不过hook对象的memoizedState是一个对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// react-dom.development.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffectImpl</span>(<span class="params">fiberFlags, hookFlags, create, deps</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">var</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  currentlyRenderingFiber$1.<span class="property">flags</span> |= fiberFlags;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(<span class="title class_">HasEffect</span> | hookFlags, create, <span class="literal">undefined</span>, nextDeps);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateEffectImpl</span>(<span class="params">fiberFlags, hookFlags, create, deps</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">var</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="keyword">var</span> destroy = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (currentHook !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> prevEffect = currentHook.<span class="property">memoizedState</span>;</span><br><span class="line">    destroy = prevEffect.<span class="property">destroy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextDeps !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> prevDeps = prevEffect.<span class="property">deps</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 👇以下代码判断useEffect的依赖是否变化。  </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) &#123;</span><br><span class="line">        hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(hookFlags, create, destroy, nextDeps);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(hook)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  currentlyRenderingFiber$1.<span class="property">flags</span> |= fiberFlags;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(<span class="title class_">HasEffect</span> | hookFlags, create, destroy, nextDeps);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffect</span>(<span class="params">create, deps</span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// $FlowExpectedError - jest isn&#x27;t a global, and isn&#x27;t recognized outside of tests</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;undefined&#x27;</span> !== <span class="keyword">typeof</span> jest) &#123;</span><br><span class="line">      <span class="title function_">warnIfNotCurrentlyActingEffectsInDEV</span>(currentlyRenderingFiber$1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">mountEffectImpl</span>(<span class="title class_">Passive</span> | <span class="title class_">PassiveStatic</span>, <span class="title class_">Passive</span>$1, create, deps);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateEffect</span>(<span class="params">create, deps</span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// $FlowExpectedError - jest isn&#x27;t a global, and isn&#x27;t recognized outside of tests</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;undefined&#x27;</span> !== <span class="keyword">typeof</span> jest) &#123;</span><br><span class="line">      <span class="title function_">warnIfNotCurrentlyActingEffectsInDEV</span>(currentlyRenderingFiber$1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateEffectImpl</span>(<span class="title class_">Passive</span>, <span class="title class_">Passive</span>$1, create, deps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateEffectImpl函数中调用areHookInputsEqual函数判断useEffect函数的依赖是否变化，看下一这个函数的实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">areHookInputsEqual</span>(<span class="params">nextDeps, prevDeps</span>) &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (ignorePreviousDependencies) &#123;</span><br><span class="line">      <span class="comment">// Only true when this component is being hot reloaded.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevDeps === <span class="literal">null</span>) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">error</span>(<span class="string">&#x27;%s received a final argument during this render, but not during &#x27;</span> + <span class="string">&#x27;the previous render. Even though the final argument is optional, &#x27;</span> + <span class="string">&#x27;its type cannot change between renders.&#x27;</span>, currentHookNameInDev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t bother comparing lengths in prod because these arrays should be</span></span><br><span class="line">    <span class="comment">// passed inline.</span></span><br><span class="line">    <span class="keyword">if</span> (nextDeps.<span class="property">length</span> !== prevDeps.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="title function_">error</span>(<span class="string">&#x27;The final argument passed to %s changed size between renders. The &#x27;</span> + <span class="string">&#x27;order and size of this array must remain constant.\n\n&#x27;</span> + <span class="string">&#x27;Previous: %s\n&#x27;</span> + <span class="string">&#x27;Incoming: %s&#x27;</span>, currentHookNameInDev, <span class="string">&quot;[&quot;</span> + prevDeps.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&quot;]&quot;</span>, <span class="string">&quot;[&quot;</span> + nextDeps.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; prevDeps.<span class="property">length</span> &amp;&amp; i &lt; nextDeps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">objectIs</span>(nextDeps[i], prevDeps[i])) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">is</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x === y &amp;&amp; (x !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y) || x !== x &amp;&amp; y !== y <span class="comment">// eslint-disable-line no-self-compare</span></span><br><span class="line">  ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> objectIs = <span class="keyword">typeof</span> <span class="title class_">Object</span>.<span class="property">is</span> === <span class="string">&#x27;function&#x27;</span> ? <span class="title class_">Object</span>.<span class="property">is</span> : is;</span><br></pre></td></tr></table></figure>
<p>该函数最终调用了<a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is">Object.is</a>比较useEffect函数第二个值的每一项是否相同。</p>
<p>在<code>mountEffectImpl</code>和<code>updateEffectImpl</code>中也分别调用了<code>mountWorkInProgressHook</code>和<code>updateWorkInProgressHook</code>，所以useEffect也会产生两个hook对象添加到链表中，有所不同的是hook对象的memoizedState的值是一个对象，他们都调用了pushEffect函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pushEffect</span>(<span class="params">tag, create, destroy, deps</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> effect = &#123;</span><br><span class="line">    <span class="attr">tag</span>: tag,</span><br><span class="line">    <span class="attr">create</span>: create,</span><br><span class="line">    <span class="attr">destroy</span>: destroy,</span><br><span class="line">    <span class="attr">deps</span>: deps,</span><br><span class="line">    <span class="comment">// Circular</span></span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> componentUpdateQueue = currentlyRenderingFiber$1.<span class="property">updateQueue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (componentUpdateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    componentUpdateQueue = <span class="title function_">createFunctionComponentUpdateQueue</span>();</span><br><span class="line">    currentlyRenderingFiber$1.<span class="property">updateQueue</span> = componentUpdateQueue;</span><br><span class="line">    componentUpdateQueue.<span class="property">lastEffect</span> = effect.<span class="property">next</span> = effect;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> lastEffect = componentUpdateQueue.<span class="property">lastEffect</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">      componentUpdateQueue.<span class="property">lastEffect</span> = effect.<span class="property">next</span> = effect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 👇以下代码形成一个环形链表，在一个函数组件内，每调用一次useEffect都会向该链表中添加一个节点。currentlyRenderingFiber$1.updateQueue为该链表的指针。</span></span><br><span class="line">      <span class="keyword">var</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">      lastEffect.<span class="property">next</span> = effect;</span><br><span class="line">      effect.<span class="property">next</span> = firstEffect;</span><br><span class="line">      componentUpdateQueue.<span class="property">lastEffect</span> = effect;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数首先声明一个effect对象，最后会返回该对象。effect的next属性说明了该对象又是一个单向链表的节点。</p>
<p>我们在自己的React组件里添加useEffect完成一些需要副作用操作的函数，来演示一下该对象的值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> [bool, setBool] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`You click <span class="subst">$&#123;state&#125;</span> times`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;first effect&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, [state]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">setAttribute</span>(<span class="string">&#x27;attr&#x27;</span>, bool);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;second effect&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, [bool]);</span><br></pre></td></tr></table></figure>
<p>打印出该组件的hook链表：<br><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/useEffect.png" alt="useEffect.png"><br>查看memoizedState的值，可以看到一个环形链表：<br><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/memoizedState1.png" alt="memoizedState1.png"><br><img src="/%E5%AD%A6%E4%B9%A0/Hooks%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93%E5%92%8C%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80/memoizedState2.png" alt="memoizedState2.png"></p>
<p>以上源码回答了调用useEffect产生的数据结构，那具体有副作用的函数在什么时候被调用呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListUnmount</span>(<span class="params">flags, finishedWork, nearestMountedAncestor</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">  <span class="keyword">var</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">var</span> effect = firstEffect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// 👇以下代码在组件销毁时，调用effect对象的destory函数</span></span><br><span class="line">        <span class="keyword">var</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line">        effect.<span class="property">destroy</span> = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="title function_">safelyCallDestroy</span>(finishedWork, nearestMountedAncestor, destroy);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effect = effect.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListMount</span>(<span class="params">tag, finishedWork</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">  <span class="keyword">var</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">var</span> effect = firstEffect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; tag) === tag) &#123;</span><br><span class="line">        <span class="comment">// 👇以下代码在组件首次挂载时调用，create函数返回的对象被赋值给destory属性。</span></span><br><span class="line">        <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">        effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">var</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span> &amp;&amp; <span class="keyword">typeof</span> destroy !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 删去一些无关代码</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effect = effect.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitHookEffectListMount函数在commitLayoutEffectOnFiber中被调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffectOnFiber</span>(<span class="params">finishedRoot, current, finishedWork, committedLanes</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((finishedWork.<span class="property">flags</span> &amp; (<span class="title class_">Update</span> | <span class="title class_">Callback</span>)) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Layout</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// 删除无关代码 </span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostText</span>:</span><br><span class="line">       </span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Profiler</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">IncompleteClassComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ScopeComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">LegacyHiddenComponent</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="title class_">Error</span>( <span class="string">&quot;This unit of work tag should not have side-effects. This error is likely caused by a bug in React. Please file an issue.&quot;</span> );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">      <span class="title function_">commitAttachRef</span>(finishedWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数较为复杂，删除一些无关代码后，整体脉络是根据组件类型做不同的处理。类似的，<code>commitHookEffectListUnmount</code>是在<code>commitPassiveUnmountOnFiber</code>函数中被调用。useEffect中的副作用操作会在会在函数组件的不同阶段被依次调用。</p>
<h3 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h3><p>useContext需要结合最新的Context API使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="string">&#x27;light&#x27;</span>); <span class="comment">// light为默认值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="comment">// dark是需要向后代节点传递的值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toolbar</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Toolbar.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Toolbar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ThemedButton</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThemeButton.js</span></span><br><span class="line"><span class="comment">// 此时this.context的值为dark</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThemedButton</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> contextType = <span class="title class_">ThemeContext</span>;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">theme</span>=<span class="string">&#123;this.context&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在ThemeButton.js中还可以用如下方式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">MyContext</span>.<span class="property">Consumer</span>&gt;</span><br><span class="line">  &#123;<span class="function"><span class="params">value</span> =&gt;</span> <span class="comment">/* 此时value的值为dark */</span>&#125;</span><br><span class="line">&lt;/<span class="title class_">MyContext</span>.<span class="property">Consumer</span>&gt;</span><br></pre></td></tr></table></figure>
<p>如果ThemeButton是函数式组件则可以用useContext的方式获取value的值:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时theme的值为dark</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ThemedButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> theme = <span class="title function_">useContext</span>(<span class="title class_">MyContext</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>&#123;theme&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以useConetext相当于类组件中的<code>static contextType = MyContext</code>或者<code>&lt;MyContext.Consumer&gt;</code>。<br>当最近的祖先元素的context的value值发生变化（即最近的<code>&lt;MyContext.Provider&gt;</code>的value属性发生变化），调用useContext的组件会重新渲染。</p>
<p>useContext的实现相对比较简单，他没有像useState和useEffect那样添加hook对象的链表。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">useContext</span>: <span class="keyword">function</span> (<span class="params">context</span>) &#123;</span><br><span class="line">  currentHookNameInDev = <span class="string">&#x27;useContext&#x27;</span>;</span><br><span class="line">  <span class="title function_">mountHookTypesDev</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">readContext</span>(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readContext</span>(<span class="params">context</span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> value =  context.<span class="property">_currentValue</span> ;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lastFullyObservedContext === context) ; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> contextItem = &#123;</span><br><span class="line">      <span class="attr">context</span>: context,</span><br><span class="line">      <span class="attr">memoizedValue</span>: value,</span><br><span class="line">      <span class="attr">next</span>: <span class="literal">null</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastContextDependency === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(currentlyRenderingFiber !== <span class="literal">null</span>)) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="title class_">Error</span>( <span class="string">&quot;Context can only be read while React is rendering. In classes, you can read it in the render method or getDerivedStateFromProps. In function components, you can read it directly in the function body, but not inside Hooks like useReducer() or useMemo().&quot;</span> );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="comment">// This is the first dependency for this component. Create a new list.</span></span><br><span class="line"></span><br><span class="line">      lastContextDependency = contextItem;</span><br><span class="line">      currentlyRenderingFiber.<span class="property">dependencies</span> = &#123;</span><br><span class="line">        <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">        <span class="attr">firstContext</span>: contextItem,</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This is an old field. Delete it.</span></span><br><span class="line">        <span class="attr">responders</span>: <span class="literal">null</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Append a new context item.</span></span><br><span class="line">      lastContextDependency = lastContextDependency.<span class="property">next</span> = contextItem;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h3><p>介绍useReducer之前考虑以下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [email, setEmail] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [age, setAge] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;name&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span> setName(event.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;email&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span> setEmail(event.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;age&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span> setAge(event.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设有一个填写用户基本信息的表单组件，该表单有多个字段，如果使用useState则需要声明多个字段，此时可以考虑使用useReducer优化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">emial</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;setName&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">name</span>: action.<span class="property">payload</span></span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;setEmail&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">email</span>: action.<span class="property">payload</span></span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;setAge&quot;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">age</span>: action.<span class="property">payload</span></span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [form, dispatch] = <span class="title function_">useReducer</span>(reducer, initState);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;form.name&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span></span></span><br><span class="line"><span class="language-xml">            dispatch(&#123; type: &quot;setName&quot;, payload: event.target.value &#125;)</span></span><br><span class="line"><span class="language-xml">          &#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;form.email&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span></span></span><br><span class="line"><span class="language-xml">            dispatch(&#123; type: &quot;setEmail&quot;, payload: event.target.value &#125;)</span></span><br><span class="line"><span class="language-xml">          &#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;form.age&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;(event)</span> =&gt;</span></span></span><br><span class="line"><span class="language-xml">            dispatch(&#123; type: &quot;setAge&quot;, payload: event.target.value &#125;)</span></span><br><span class="line"><span class="language-xml">          &#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到useReducer借鉴了Redux的思想。useReducer的第一个参数是reducer函数，他也必须是一个纯函数，返回一个新的对象引用。第二个参数是创建的state的默认值。实际上在React内部，useState就是靠useReducer来实现的。<br>该函数的第三个可选参数是一个函数，该函数会接收useReducer的第二个参数initState作为参数，返回的值作为创建的statet的默认值，该参数允许对传入的initState做进一步计算处理，返回新的initState。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;Neil&quot;</span>,</span><br><span class="line">  <span class="attr">email</span>: <span class="string">&quot;admin@test.com&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params">initState</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...initState,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">`name: <span class="subst">$&#123;initState.name&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">email</span>: <span class="string">`email: <span class="subst">$&#123;initState.email&#125;</span>`</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在组件内，生成的form的默认值为</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//    age: 0,</span></span><br><span class="line"><span class="comment">//    name: &quot;name: Neil&quot;,</span></span><br><span class="line"><span class="comment">//    email: &quot;email: admin@test.com&quot;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">const</span> [form, dispatch] = <span class="title function_">useReducer</span>(reducer, initState, init);</span><br></pre></td></tr></table></figure>

<p>useReducer的底层实现分别调用mountReducer和updateReducer，这个与useState相似，useState在首次渲染阶段调用了mountState函数，在更新阶段也是调用了updateReducer函数。区别只是useReducer返回值是一个对象，和一个dispatch函数，dispatch函数可以接收action对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountReducer</span>(<span class="params">reducer, initialArg, init</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">var</span> initialState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (init !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    initialState = <span class="title function_">init</span>(initialArg);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    initialState = initialArg;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line">  <span class="keyword">var</span> queue = hook.<span class="property">queue</span> = &#123;</span><br><span class="line">    <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">interleaved</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastRenderedReducer</span>: reducer,</span><br><span class="line">    <span class="attr">lastRenderedState</span>: initialState</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> dispatch = queue.<span class="property">dispatch</span> = dispatchAction.<span class="title function_">bind</span>(<span class="literal">null</span>, currentlyRenderingFiber$1, queue);</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到mountReducer和mountState函数的实现也极为相似。只是初始值的设置不同。</p>


                

                <ul class="pager">
                    
                        <li class="previous"><a href="/学习/Hooks使用总结和源码解析-二.html">&larr;  上一篇</a></li>
                    
                    
                        <li class="next"><a href="/总结/position-sticky属性详解.html">下一篇 &rarr;</a></li>
                    
                </ul>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/neilning-xc" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="mailto:ningcoder@foxmail.com" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 Neil Ning<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/" rel="external nofollow noreferrer">Clean Blog</a> from <a href="http://startbootstrap.com/" rel="external nofollow noreferrer" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer">Hexo</a> by <a href="http://www.codeblocq.com/" rel="external nofollow noreferrer" target="_blank">Jonathan Klughertz</a></p>
                <!-- <p class="copyright text-muted"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.miitbeian.gov.cn/">豫ICP备19003046号</a></p> -->
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//lib.baomitu.com/jquery/2.1.4/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="//lib.baomitu.com/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>