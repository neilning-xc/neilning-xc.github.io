<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="Tell the world with code"/>
    

    <!--Author-->
    
        <meta name="author" content="Neil Ning"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Kuberneteså…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Tell the world with code"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Neilçš„åšå®¢"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

    <!-- Title -->
    
    <title>Kuberneteså…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰ - Neilçš„åšå®¢</title>

    <!-- Bootstrap Core CSS -->
    <link href="//lib.baomitu.com/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.css" rel="stylesheet"/>

    <!-- Google Analytics -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPEMLKFYYW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ZPEMLKFYYW');
    </script>



    <!-- favicon -->
    

<meta name="generator" content="Hexo 5.4.2"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Neilçš„åšå®¢</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                é¦–é¡µ
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                å½’æ¡£
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                æ ‡ç­¾
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                åˆ†ç±»
                            
                        </a>
                    </li>
                
                    <li>
                        <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/neilning-xc/neilning-xc.github.io">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header post-header" style="background-image: url('Kuberneteså…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰/bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Kuberneteså…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Neil Ning on
                        
                        
                            2023-09-10
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/kubernetes/">#kubernetes</a> <a href="/tags/minikube/">#minikube</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/å­¦ä¹ /">å­¦ä¹ </a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="kubernetesç®€ä»‹"><a href="#kubernetesç®€ä»‹" class="headerlink" title="kubernetesç®€ä»‹"></a>kubernetesç®€ä»‹</h2><p>Kubernetesæ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œå·²ç»æ˜¯ä¸»æµçš„åº”ç”¨éƒ¨ç½²å·¥å…·ï¼Œä½œä¸ºå¼€å‘äººå‘˜æœ‰å¿…è¦å¯¹è¿™ä¸ªå·¥å…·æœ‰ä¸€å®šçš„äº†è§£ï¼Œä¸‹é¢å¯¹Kubernetesåšä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚</p>
<p>Kubernetesé›†ç¾¤ç”±è‹¥å¹²å·¥ä½œèŠ‚ç‚¹(work machine)ç»„æˆï¼Œä»–ä»¬è¢«ç§°ä¸ºnodesã€‚ç®¡ç†è¿™äº›å·¥ä½œèŠ‚ç‚¹ç»„ä»¶è¢«è¢«ç§°ä¸ºæ§åˆ¶é¢ï¼ˆControl Planeï¼‰æˆ–è€…ä¸»èŠ‚ç‚¹ï¼ŒControl Planeç”±å¤šä¸ªç»„ä»¶æ„æˆï¼Œæ¯ä¸ªç»„ä»¶è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯Kubernetesé›†ç¾¤çš„ç»„ä»¶æ¶æ„å›¾ã€‚<br><img src="/%E5%AD%A6%E4%B9%A0/Kubernetes%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/post1.png" alt="post1.png"><br>æ§åˆ¶é¢ç›¸å½“äºé›†ç¾¤ä¸­çš„æŒ‡æŒ¥å®˜ï¼Œæ§åˆ¶æ•´ä¸ªé›†ç¾¤çš„èµ„æºå’ŒçŠ¶æ€ï¼Œä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶æ„æˆï¼š</p>
<ul>
<li>kube-apiserverï¼Œæ§åˆ¶é¢å‘å…¶ä»–å„ä¸ªç»„ä»¶çš„å‘æŒ‡ä»¤çš„æ¢çº½ï¼Œä¹Ÿæ˜¯é›†ç¾¤ä¸­å„ä¸ªç»„ä»¶ç›¸äº’æ²Ÿé€šçš„æ¢çº½ã€‚ä»–ä¹Ÿæš´éœ²ä¸€äº›APIï¼Œåé¢é€šè¿‡kubectlè¿è¡Œå‘½ä»¤å°±æ˜¯å‘apiserverå‘é€è¯·æ±‚ã€‚</li>
<li>etcdï¼Œä¸€è‡´ä¸”é«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ï¼Œç”¨ä½œKubernetesé›†ç¾¤æ•°æ®çš„æ•°æ®åº“ã€‚</li>
<li>kube-schedulerï¼Œè´Ÿè´£ç›‘è§†ã€åˆ›å»ºNodeæˆ–è€…Podã€‚</li>
<li>kube-controller-managerï¼Œæ§åˆ¶èŠ‚ç‚¹ã€ä»»åŠ¡ç­‰ã€‚</li>
</ul>
<p><img src="/%E5%AD%A6%E4%B9%A0/Kubernetes%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/post2.png" alt="post2.png"></p>
<p>ä¸Šå›¾æ˜¯å·¥ä½œèŠ‚ç‚¹çš„æ¶æ„å›¾ï¼Œå·¥ä½œèŠ‚ç‚¹æ˜¯æ‰§è¡Œå…·ä½“ä»»åŠ¡çš„å•å…ƒï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå·¥ä½œåŠè¯¶ç‚¹ä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶æ„æˆï¼š</p>
<ul>
<li>kubeletï¼Œç®¡ç†èŠ‚ç‚¹ä¸Šçš„podï¼Œç¡®ä¿podæˆ–å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œå‘apiserveræŠ¥å‘ŠæŸä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¹Ÿæ¥æ”¶æ¥è‡ªapiserveræŒ‡ä»¤ã€‚</li>
<li>kube-proxyï¼ŒèŠ‚ç‚¹çš„ç½‘ç»œä»£ç†ï¼Œç»´æŠ¤ä¸€äº›ç½‘ç»œè§„åˆ™ï¼Œå…è®¸èŠ‚ç‚¹å†…podå’Œå¤–ç•Œçš„é€šä¿¡ã€‚</li>
<li>container runtimeï¼Œå®¹å™¨è¿è¡Œæ—¶,Kubernetesæ”¯æŒå¤šç§å®¹å™¨è¿è¡Œæ—¶ï¼Œæœ€å¸¸è§çš„æ˜¯dockerã€‚</li>
<li>podï¼Œè¯¥ç»„ä»¶æ˜¯kubernetesé›†ç¾¤ä¸­çš„æœ€å°å•å…ƒï¼Œè¿è¡Œç€åº”ç”¨å®¹å™¨ã€‚</li>
</ul>
<p>å‰æœŸå­¦ä¹ å¯¹ä»¥ä¸Šå„ä¸ªç»„ä»¶çš„èŒèƒ½æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£å³å¯ã€‚</p>
<h2 id="å®‰è£…minikube"><a href="#å®‰è£…minikube" class="headerlink" title="å®‰è£…minikube"></a>å®‰è£…minikube</h2><p>åˆ›å»ºä¸€ä¸ªè¾ƒä¸ºå®Œæ•´å¯ç”¨çš„Kubernetesé›†ç¾¤ï¼Œéœ€è¦ä¸‰å°ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºï¼Œä¸€å°ä½œä¸ºmasterèŠ‚ç‚¹ï¼Œå¦å¤–ä¸¤å°ä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚è¿™ä½¿å¾—åœ¨æœ¬åœ°è°ƒè¯•å¾ˆä¸æ–¹ä¾¿ï¼Œå› æ­¤å®˜æ–¹æä¾›äº†minikubeå·¥å…·ï¼Œå¯ä»¥åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªKubernetesé›†ç¾¤ï¼Œminikubeçš„å®‰è£…è¿‡ç¨‹<a target="_blank" rel="noopener external nofollow noreferrer" href="https://minikube.sigs.k8s.io/docs/start/">å‚è€ƒè¿™é‡Œ</a>ã€‚å®‰è£…å®Œä¹‹åæ‰§è¡Œ<code>minikube start</code>å¯ä»¥å¯åŠ¨ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚é€šè¿‡<code>minikube pause</code>æˆ–<code>minikube stop</code>å‘½ä»¤å¯ä»¥åœæ­¢è¯¥é›†ç¾¤ï¼Œminikubeå…¶ä»–çš„å¯ç”¨å‘½ä»¤å¯ä»¥<a target="_blank" rel="noopener external nofollow noreferrer" href="https://minikube.sigs.k8s.io/docs/handbook/controls/">å‚è€ƒè¿™é‡Œ</a>æˆ–æ‰§è¡Œ<code>minikube help</code>æŸ¥çœ‹å¸®åŠ©æ‰‹å†Œã€‚</p>
<p>åœ¨æœ¬åœ°å®‰è£…Kubernetesé›†ç¾¤é™¤äº†minikubeä¹‹å¤–è¿˜æœ‰å…¶ä»–çš„å·¥å…·ï¼Œå¦‚kindã€kubeadmã€‚å¯ä»¥<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/tools/">å‚è€ƒè¿™é‡Œ</a>å­¦ä¹ å…¶ä»–å·¥ä½œçš„å®‰è£…æ–¹å¼ã€‚</p>
<h2 id="åˆ›å»ºdeployment"><a href="#åˆ›å»ºdeployment" class="headerlink" title="åˆ›å»ºdeployment"></a>åˆ›å»ºdeployment</h2><p>ä½¿ç”¨minikubeåˆ›å»ºå¥½é›†ç¾¤ä¹‹åï¼Œæˆ‘ä»¬æœ¬åœ°åˆ›å»ºä¸€ä¸ªnodejsåº”ç”¨ï¼Œå¹¶å°†å…¶æ„å»ºæˆdockeré•œåƒã€‚åˆ›å»ºapp.js:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const app = express();</span><br><span class="line">const port = 4000;</span><br><span class="line"></span><br><span class="line">const podname= process.env.HOSTNAME;</span><br><span class="line">let requests = 0;</span><br><span class="line">let startTime;</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;,  (req, res) =&gt; &#123;</span><br><span class="line">  res.send(`Hello world, it&#x27;s $&#123;podname&#125;(v1)\n`);</span><br><span class="line">  console.log(`Running On: $&#123;podname&#125; | Total Requests: $&#123;++requests&#125; | App Uptime: $&#123;(new Date() - startTime)/1000&#125; seconds | Log Time: $&#123;new Date()&#125;`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">  startTime = new Date();</span><br><span class="line">  console.log(`Example app listening on port $&#123;port&#125; at $&#123;startTime&#125; | Running On: $&#123;podname&#125;\n`)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>åº”è¯¥ç»‘å®šçš„ç«¯å£å·ä¸º4000ï¼Œæ‰€ä»¥åœ¨Dockerfileä¸­æˆ‘ä»¬å°†å®¹å™¨çš„4000ç«¯å£æš´éœ²å‡ºæ¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM node:16</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/src/app</span><br><span class="line"></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line">RUN npm install</span><br><span class="line"></span><br><span class="line">EXPOSE 4000</span><br><span class="line"></span><br><span class="line">CMD [ &quot;npm&quot;, &quot;run&quot;, &quot;start&quot; ]</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨docker buildå‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå¥½çš„é•œåƒæ˜¯åœ¨æœ¬æœºçš„dockerä»“åº“ä¸­çš„ï¼Œè€Œä¸‹é¢è¦å®éªŒçš„Kubernetesé›†ç¾¤é»˜è®¤æ˜¯ä¸ä¼šä»æœ¬åœ°çš„dockerä¸­æ‹‰å–é•œåƒçš„ã€‚</p>
<p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯æœ¬åœ°çš„minikubeé›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æ„å»ºçš„é•œåƒå¯¼å…¥åˆ°minikubeé›†ç¾¤ä¸­ï¼Œè¿™æ ·åœ¨k8sé›†ç¾¤ä¸­éƒ¨ç½²åº”ç”¨æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨æˆ‘ä»¬æ„å»ºå¥½çš„æœ¬åœ°é•œåƒã€‚è¯¦ç»†è¿‡ç¨‹<a target="_blank" rel="noopener external nofollow noreferrer" href="https://minikube.sigs.k8s.io/docs/handbook/pushing/">å‚è€ƒè¿™é‡Œ</a>ï¼Œè¯¥è¿‡ç¨‹å¦‚ä¸‹ã€‚å…ˆåœ¨å½“å‰ç»ˆç«¯æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval $(minikube docker-env)</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä¹‹åï¼Œåœ¨å½“å‰ç»ˆç«¯æ‰§è¡Œçš„ä»»ä½•dockerå‘½ä»¤éƒ½ç›¸å½“äºè¿è¡Œåœ¨minikubeé›†ç¾¤å½“ä¸­ã€‚ç„¶åæˆ‘ä»¬è¿è¡Œdocker buildæ„å»ºä¸Šé¢çš„åº”ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t backend-express-demo:v1 .</span><br></pre></td></tr></table></figure>
<p>æ„å»ºæˆåŠŸä¹‹åæˆ‘ä»¬å°±å¯ä»¥å°†å½“å‰é•œåƒå‘å¸ƒåˆ°k8sé›†ç¾¤å½“ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment backend-express-demo --image=backend-express-demo:v1 --replicas=2</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„deploymentï¼Œåç§°ä¸ºbackend-express-demoï¼Œä½¿ç”¨çš„é•œåƒæ˜¯æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„backend-express-demo:v1é•œåƒï¼Œå¦å¤–æŒ‡å®šå½“å‰åº”ç”¨çš„podæ•°é‡ä¸º2ã€‚æ‰§è¡Œ<code>kubectl get pods</code>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ä¸¤ä¸ªpodã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">backend-express-demo-7bb844bff9-gj7j6   1/1     Running   0          16h</span><br><span class="line">backend-express-demo-7bb844bff9-qlvjr   1/1     Running   0          16h</span><br></pre></td></tr></table></figure>
<p>å½“å‰éƒ¨ç½²çš„ä¸¤ä¸ªpodsåœ¨é›†ç¾¤å†…éƒ¨ï¼Œå¤–éƒ¨è¿˜ä¸èƒ½è®¿é—®ã€‚æˆ‘ä»¬å…ˆéªŒè¯ä¸‹éƒ¨ç½²çš„podæ˜¯å¦è¿è¡Œæ­£å¸¸ï¼Œè°ƒè¯•çš„è¿‡ç¨‹éœ€è¦ä½¿ç”¨podçš„åç§°ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§æˆ‘ä»¬å°†podçš„åç§°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export POD_NAME=&quot;$(kubectl get pods -o go-template --template &#x27;&#123;&#123;(index .items 0).metadata.name&#125;&#125;&#123;&#123;&quot;\n&quot;&#125;&#125;&#x27;)&quot;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‘½ä»¤ä½¿ç”¨go-templateå°†kubectl get podsçš„è¾“å‡ºç»“æœæ ¼å¼åŒ–ï¼Œç„¶åè¿‡æ»¤å¹¶è·å–åˆ°ç¬¬ä¸€ä¸ªpodçš„åç§°ï¼Œgo-templateçš„ç”¨æ³•<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pkg.go.dev/text/template">å‚è€ƒè¿™é‡Œ</a>ã€‚æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„podå¤„åœ¨k8sé›†ç¾¤ä¸­ç§æœ‰çš„éš”ç¦»ç½‘ç»œç¯å¢ƒä¸­ï¼Œå½“å‰å¤–éƒ¨çš„è¯·æ±‚éœ€è¦é€šè¿‡ä»£ç†æ‰èƒ½æ­£å¸¸åˆ°è¾¾åº”ç”¨ã€‚æ–°å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ<code>kubectl proxy</code>æ¥å¼€å¯ä»£ç†ï¼Œç„¶åä½¿ç”¨curlå‘é€å¦‚ä¸‹è¯·æ±‚æ¥æŸ¥çœ‹åº”ç”¨æ˜¯å¦æ­£å¸¸å“åº”ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8001/api/v1/namespaces/default/pods/$POD_NAME:8080/proxy/</span><br></pre></td></tr></table></figure>
<p>è¿˜å¯ä»¥æŸ¥çœ‹podå†…çš„æ—¥å¿—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs $POD_NAME</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…è¿›å…¥é•œåƒå†…éƒ¨æŸ¥çœ‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -ti $POD_NAME -- bash</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥é•œåƒå†…åè¿è¡Œcurlå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°nodejsåº”ç”¨çš„å“åº”ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:4000</span><br></pre></td></tr></table></figure>
<h2 id="åˆ›å»ºservice"><a href="#åˆ›å»ºservice" class="headerlink" title="åˆ›å»ºservice"></a>åˆ›å»ºservice</h2><p>ä¸Šé¢åªæ˜¯åˆ›å»ºäº†deploymentï¼Œæƒ³è¦å¤–éƒ¨è¯·æ±‚èƒ½å¤Ÿè®¿é—®åˆšåˆšéƒ¨ç½²çš„åº”ç”¨ï¼Œè¿˜éœ€è¦åˆ›å»ºserviceã€‚k8sä¸­æœ‰ä¸¤ç§ç±»å‹çš„service:</p>
<ul>
<li>NodePort</li>
<li>LoadBalancer</li>
</ul>
<h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>æˆ‘ä»¬å…ˆåˆ›å»ºNodePortç±»å‹çš„serviceã€‚åˆ›å»ºserviceä¹‹å‰å…ˆæ¥æŸ¥çœ‹å½“å‰serviceï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get services</span><br><span class="line"># æˆ–</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥å¦‚ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªé»˜è®¤çš„service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â¯ kubectl get services</span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">backend-express-demo   NodePort    10.103.220.33   &lt;none&gt;        4000:32690/TCP   19h</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬é€šè¿‡kubectl exposeå‘½ä»¤ä¸ºä¸Šé¢åˆ›å»ºçš„deploymentåˆ›å»ºservice</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment/backend-express-demo --type=&quot;NodePort&quot; --port 4000</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢åˆ›å»ºçš„serviceçš„typeä¸ºNodePortï¼Œç«¯å£å·ä¸º4000ï¼ŒæŸ¥çœ‹åˆ›å»ºçš„service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">backend-express-demo   NodePort    10.103.220.33   &lt;none&gt;        4000:32690/TCP   19h</span><br><span class="line">kubernetes             ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          42h</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œç”±äºdockeråœ¨éLinuxç³»ç»Ÿçš„ç½‘ç»œé™åˆ¶ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¿é—®minikubeä¸­çš„èŠ‚ç‚¹IPï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªé€šé“(tunnel)æ¥è®¿é—®backend-express-demoã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube service backend-express-demo --url</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|-----------|----------------------|-------------|---------------------------|</span><br><span class="line">| NAMESPACE |         NAME         | TARGET PORT |            URL            |</span><br><span class="line">|-----------|----------------------|-------------|---------------------------|</span><br><span class="line">| default   | backend-express-demo |        4000 | http://192.168.49.2:32690 |</span><br><span class="line">|-----------|----------------------|-------------|---------------------------|</span><br><span class="line">ğŸƒ  Starting tunnel for service backend-express-demo.</span><br><span class="line">|-----------|----------------------|-------------|------------------------|</span><br><span class="line">| NAMESPACE |         NAME         | TARGET PORT |          URL           |</span><br><span class="line">|-----------|----------------------|-------------|------------------------|</span><br><span class="line">| default   | backend-express-demo |             | http://127.0.0.1:61512 |</span><br><span class="line">|-----------|----------------------|-------------|------------------------|</span><br><span class="line">ğŸ‰  æ­£é€šè¿‡é»˜è®¤æµè§ˆå™¨æ‰“å¼€æœåŠ¡ default/backend-express-demo...</span><br><span class="line">â—  å› ä¸ºä½ æ­£åœ¨ä½¿ç”¨ darwin ä¸Šçš„ Docker é©±åŠ¨ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦æ‰“å¼€ç»ˆç«¯æ‰èƒ½è¿è¡Œå®ƒã€‚</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åœ¨æœ¬æœºæµè§ˆå™¨è®¿é—®<code>http://127.0.0.1:61512</code>æˆ–è€…æ‰§è¡Œ<code>curl http://127.0.0.1:61512</code>å°±å¯ä»¥è®¿é—®æˆ‘ä»¬åˆšåˆšéƒ¨ç½²çš„nodejsåº”ç”¨ã€‚</p>
<h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><p>å°†serviceæš´éœ²åˆ°é›†ç¾¤å¤–éƒ¨ç½‘ç»œçš„æ ‡å‡†æ–¹å¼æ˜¯åˆ›å»ºä¸€ä¸ªLoadBalancerç±»å‹çš„serviceï¼Œåˆ›å»ºçš„æ–¹å¼å’Œä¸Šé¢ç±»ä¼¼ï¼Œä¸è¿‡åˆ›å»ºserviceä¹‹å‰è¦å…ˆåˆ é™¤ä¹‹å‰çš„åˆ›å»ºçš„NodePortç±»å‹çš„serviceï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete service backend-express-demo</span><br></pre></td></tr></table></figure>
<p>ç”±äºæœ¬åœ°ä½¿ç”¨çš„æ˜¯minikubeé›†ç¾¤ï¼Œ<strong>æ‰€ä»¥åˆ›å»ºserviceä¹‹å‰éœ€è¦åœ¨æ–°çš„ç»ˆç«¯ä¸­è¿è¡Œ<code>minikube tunnel</code>åˆ›å»ºä¸€ä¸ªé€šé“ï¼ˆtunnelï¼‰</strong>ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºLoadBalancerç±»å‹çš„serviceï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment/backend-express-demo --type=LoadBalancer --port 4000</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä¹‹åè¿è¡Œ<code>kubectl get svc</code>æŸ¥çœ‹æ–°çš„serviceï¼Œç”±äºæˆ‘ä»¬æ˜¯åœ¨minikubeé›†ç¾¤ä¸­ï¼Œä¸”ä¸Šé¢è¿è¡Œäº†<code>minikube tunnel</code>åˆ›å»ºäº†ä¸€ä¸ªé€šé“ï¼Œæ‰€ä»¥åœ¨EXTERNAL-IPåˆ—å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„serviceè¢«åˆ†é…äº†<code>127.0.0.1</code>ï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œ<code>minikube tunnel</code>ï¼ŒEXTERNAL-IPåˆ—å°†ä¼šä¸€ç›´æ˜¾ç¤ºâ€pendingâ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">backend-express-demo   LoadBalancer   10.103.171.149   127.0.0.1     4000:30504/TCP   2s</span><br><span class="line">kubernetes             ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          90m</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨EXTERNAL-IPæ¥è®¿é—®åº”ç”¨ï¼Œå¦‚å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<code>http://127.0.0.1:4000/</code>ã€‚</p>
<blockquote>
<p>æœ‰å…³minikubeé€šé“çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥<a target="_blank" rel="noopener external nofollow noreferrer" href="https://minikube.sigs.k8s.io/docs/handbook/accessing/">å‚è€ƒè¿™é‡Œ</a>ã€‚</p>
</blockquote>
<h2 id="æ‰©ç¼©å®¹"><a href="#æ‰©ç¼©å®¹" class="headerlink" title="æ‰©ç¼©å®¹"></a>æ‰©ç¼©å®¹</h2><p>ä¸Šé¢åˆ›å»ºdeploymentæ—¶ï¼ŒæŒ‡å®šçš„podsæ•°é‡æ˜¯2ã€‚k8så¯ä»¥æ ¹æ®è¯·æ±‚é‡çš„å¤§å°åŠ¨æ€çš„æ‰©å®¹æˆ–è€…ç¼©å®¹ã€‚æ¼”ç¤ºæ‰©ç¼©å®¹ä¹‹å‰æˆ‘ä»¬ç°åœ¨æ–°çš„ç»ˆç«¯ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒåŠ¨æ€çš„è§‚å¯Ÿpodæ•°é‡ä»¥åŠpodçš„åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -w</span><br></pre></td></tr></table></figure>
<p>å›åˆ°ä¹‹å‰çš„ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯ä»¥æ‰©å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployments/backend-express-demo --replicas=4</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä¹‹åæŸ¥çœ‹podæ•°é‡çš„å˜åŒ–ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME                                    READY   STATUS              RESTARTS   AGE</span><br><span class="line">backend-express-demo-7bb844bff9-9rmd9   1/1     Running             0          20m</span><br><span class="line">backend-express-demo-7bb844bff9-njjgq   1/1     Running             0          20m</span><br><span class="line">backend-express-demo-7bb844bff9-675rw   0/1     Pending             0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-675rw   0/1     Pending             0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-njscq   0/1     Pending             0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-675rw   0/1     ContainerCreating   0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-njscq   0/1     Pending             0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-njscq   0/1     ContainerCreating   0          0s</span><br><span class="line">backend-express-demo-7bb844bff9-675rw   1/1     Running             0          1s</span><br><span class="line">backend-express-demo-7bb844bff9-njscq   1/1     Running             0          1s</span><br></pre></td></tr></table></figure>
<p>k8sæ–°åˆ›å»ºäº†ä¸¤ä¸ªæ–°çš„podï¼Œå¦‚æœæƒ³ç¼©å®¹ï¼Œæˆ‘ä»¬ç›´æ¥å°†podæ•°é‡æ”¹å°å³å¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployments/backend-express-demo --replicas=2</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸€æ®µæ—¶é—´åpodè¢«é”€æ¯ã€‚</p>
<h2 id="æ›´æ–°å’Œå›æ»šåº”ç”¨"><a href="#æ›´æ–°å’Œå›æ»šåº”ç”¨" class="headerlink" title="æ›´æ–°å’Œå›æ»šåº”ç”¨"></a>æ›´æ–°å’Œå›æ»šåº”ç”¨</h2><p>å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ä¿®æ”¹äº†ä¹‹åè¦é‡æ–°å‘å¸ƒï¼Œk8sä¼šæ»šåŠ¨å¼çš„æ›´æ–°åº”ç”¨ï¼Œå³é€æ­¥æ›¿æ¢è€çš„podã€‚å¦‚æœæˆ‘ä»¬æœ‰è‡³å°‘ä¸¤ä¸ªpodï¼Œå°±èƒ½åšåˆ°å‘å¸ƒæ—¶æœåŠ¡ä¸ä¸­æ–­ã€‚åœ¨æ¼”ç¤ºåº”ç”¨æ›´æ–°ä¹‹å‰ï¼Œå…ˆæ¥ä¿®æ”¹åº”ç”¨ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(&#x27;/&#x27;,  (req, res) =&gt; &#123;</span><br><span class="line">  res.send(`Hello world, it&#x27;s $&#123;podname&#125;(v2)\n`);</span><br><span class="line">  console.log(`Running On: $&#123;podname&#125; | Total Requests: $&#123;++requests&#125; | App Uptime: $&#123;(new Date() - startTime)/1000&#125; seconds | Log Time: $&#123;new Date()&#125;`);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°†ä¿®æ”¹åçš„ä»£ç æ‰“åŒ…æˆv2ç‰ˆæœ¬çš„é•œåƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t backend-express-demo:v2 .</span><br></pre></td></tr></table></figure>
<p>é•œåƒæ„å»ºæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å°†ä¸Šé¢åˆ›å»ºçš„deploymentæ›´æ–°ä¸ºæ–°çš„é•œåƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployments/backend-express-demo backend-express-demo=backend-express-demo:v2</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥è§‚å¯Ÿåˆ°æ›´æ–°åº”ç”¨æ—¶å…ˆåˆ›å»ºäº†æ–°çš„v2ç‰ˆæœ¬é•œåƒçš„podï¼Œç„¶åé€æ­¥åˆ é™¤è€çš„podï¼Œä¸”ç”±äºæˆ‘ä»¬æœ‰ä¸¤ä¸ªpodsï¼Œæ‰€ä»¥æœåŠ¡ä¸ä¼šä¸­æ–­ã€‚<br>å¦‚æœå·²ç»å‘åˆ°çº¿ä¸Šçš„åº”ç”¨è¦å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployments/backend-express-demo</span><br></pre></td></tr></table></figure>
<p>æ‰€æœ‰æ¼”ç¤ºå®Œæ¯•åå¯ä»¥æ¸…ç†åˆšåˆšåˆ›å»ºçš„deploymentå’Œservice</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments/backend-express-demo services/backend-express-demo</span><br></pre></td></tr></table></figure>
<h2 id="Kubernetes-Dashboard"><a href="#Kubernetes-Dashboard" class="headerlink" title="Kubernetes Dashboard"></a>Kubernetes Dashboard</h2><p>k8sæä¾›äº†dashboardæ¥æ–¹ä¾¿çš„ç®¡ç†k8sä¸­çš„å„ç§èµ„æºï¼Œç”±äºæˆ‘ä»¬æœ¬åœ°ä½¿ç”¨äº†minikubeï¼Œå¯ä»¥ä½¿ç”¨minikubeçš„æ’ä»¶æ¥å¼€å¯æ­¤dashboardã€‚å…ˆå®‰è£…dashboardæ‰€å¿…é¡»çš„æ’ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube addons enable metrics-server</span><br></pre></td></tr></table></figure>
<p>æ’ä»¶å®‰è£…æˆåŠŸåï¼Œå¼€å¯dashboardã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube dashboard</span><br></pre></td></tr></table></figure>
<p>å‡ åˆ†é’Ÿä¹‹åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€dashboardï¼Œåœ¨dashboardä¸­å¯ä»¥æ›´ç›´è§‚çš„çœ‹åˆ°ä¸Šé¢åˆ›å»ºdeplymentã€serviceèµ„æºã€æ‰©ç¼©å®¹ã€æ›´æ–°å’Œå›æ»šçš„è¿‡ç¨‹ã€‚<br><img src="/%E5%AD%A6%E4%B9%A0/Kubernetes%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/post3.png" alt="post3.png"></p>
<h2 id="ä½¿ç”¨yamlé…ç½®æ–‡ä»¶"><a href="#ä½¿ç”¨yamlé…ç½®æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨yamlé…ç½®æ–‡ä»¶"></a>ä½¿ç”¨yamlé…ç½®æ–‡ä»¶</h2><p>ä¸Šé¢æ¼”ç¤ºk8sçš„åŠŸèƒ½ä½¿ç”¨çš„æ˜¯å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œk8så½“ç„¶ä¹Ÿåªæ˜¯ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥ç®¡ç†åº”ç”¨ã€‚æˆ‘ä»¬æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚åˆ›å»ºdeployment.yamlï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-express-demo</span><br><span class="line">  labels: </span><br><span class="line">    app: backend-express-demo</span><br><span class="line">    role: backend</span><br><span class="line">    env: test</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: backend-express-demo</span><br><span class="line">  replicas: 2    </span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: backend-express-demo</span><br><span class="line">        role: backend</span><br><span class="line">        env: test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: backend-express-demo</span><br><span class="line">        image: backend-express-demo:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 4000</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºdeploymentä¹‹åï¼Œä¸ºäº†æ­£å¸¸çš„è®¿é—®æ–°åˆ›å»ºçš„LoadBlancerç±»å‹çš„serviceï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒä¸Šé¢çš„<code>minikube tunnel</code>è¿è¡Œã€‚åˆ›å»ºservice.yamlï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-express-demo</span><br><span class="line">  labels:</span><br><span class="line">    app: backend-express-demo</span><br><span class="line">    role: backend</span><br><span class="line">    env: test</span><br><span class="line">spec:</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">  - port: 4000</span><br><span class="line">  selector:</span><br><span class="line">    app: backend-express-demo</span><br><span class="line">    role: backend</span><br><span class="line">    env: test</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæˆåŠŸä¹‹åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®<code>http://127.0.0.1:4000/</code>æ¥æŸ¥çœ‹åº”ç”¨çš„è¾“å‡ºã€‚<br>æˆ‘ä»¬è¿˜å¯ä»¥å°†ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶å†™åœ¨åŒä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œä»…é ä¸€æ¡å‘½ä»¤å°±å¯ä»¥åŒæ—¶åˆ›å»ºdeploymentå’Œserviceï¼Œä¸¤éƒ¨åˆ†é…ç½®é€šè¿‡<code>---</code>åˆ†éš”ã€‚ä¾‹å¦‚å¦‚ä¸‹deployment-service.yamlæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      containers:</span><br><span class="line">      - name: backend-express-demo</span><br><span class="line">        image: backend-express-demo:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 4000</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-express-demo</span><br><span class="line">  labels:</span><br><span class="line">    app: backend-express-demo</span><br><span class="line">    role: backend</span><br><span class="line">    env: test</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f depoyment-service.yaml</span><br></pre></td></tr></table></figure>

<h2 id="è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰"><a href="#è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰" class="headerlink" title="è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰"></a>è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰</h2><p>ä¸Šé¢æ¼”ç¤ºæ‰‹åŠ¨æ‰©ç¼©å®¹ï¼Œk8så½“ç„¶ä¹Ÿæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHorizontalPodAutoscalerï¼‰ï¼Œå®ç°è‡ªåŠ¨æ‰©ç¼©å®¹çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ã€‚</p>
<p>åœ¨æ¼”ç¤ºHPAåŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦å…ˆåœ¨é›†ç¾¤ä¸­å®‰è£…å¹¶é…ç½®<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes-sigs/metrics-server#readme">Metrics Server</a>ï¼ŒMetrics Serveré€šè¿‡kubeletsæ”¶é›†é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œç„¶åè°ƒç”¨<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/">Kubernetes API</a>å°†æ•°æ®ä¸ŠæŠ¥ç»™masterèŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">APIService</a>åˆ›å»ºæ–°çš„èµ„æºæ»¡è¶³h paçš„è®¾ç½®è¦æ±‚ã€‚ç”±äºæˆ‘ä»¬æ¼”ç¤ºçš„ç¯å¢ƒæ˜¯minikubeï¼Œå¯ä»¥å¯ç”¨minikubeçš„metrics-serveræ’ä»¶ç®€å•çš„ä¸€é”®å®‰è£…å’Œé…ç½®Metrics Serverï¼Œä¸Šæ–‡æ¼”ç¤ºminikubeä¸­çš„k8s dashboardæ—¶å·²ç»å¯ç”¨è¿‡è¯¥æ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰§è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹ã€‚</p>
<p>å…ˆæ‰§è¡Œ<code>kubectl get hpa</code>æ¥æŸ¥çœ‹å½“å‰æ²¡æœ‰åˆ›å»ºè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œç„¶åæ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deployment backend-express-demo --cpu-percent=5 --min=2 --max=10</span><br></pre></td></tr></table></figure>
<p>è¯¥æŒ‡ä»¤è®¾ç½®æœ€å°çš„podæ•°é‡ä¸º2ï¼Œæœ€å¤§æ•°é‡ä¸º10ï¼Œä¸ºäº†æ¼”ç¤ºå°†CPUçš„ä½¿ç”¨ç‡é˜ˆå€¼è®¾ç½®ä¸º5%ï¼Œå³å½“CPUä½¿ç”¨ç‡è¶…è¿‡5%æ—¶ä¼šæ‰§è¡Œè‡ªåŠ¨æ‰©å®¹ï¼Œæœ€ç»ˆä¿è¯æ‰€æœ‰podå¹³å‡çš„CPUä½¿ç”¨ç‡ä¸º5%å·¦å³ã€‚å†æ¬¡æ‰§è¡Œ<code>kubectl get hpa</code>æŸ¥çœ‹hpaï¼Œè¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                   REFERENCE                         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   0%/5%    2         10        2          80s</span><br></pre></td></tr></table></figure>
<p>ç”±äºå½“å‰åº”ç”¨æ²¡æœ‰ä»»ä½•çš„è¯·æ±‚ï¼Œæ‰€ä»¥TARGETSåˆ—çš„CPUä½¿ç”¨ç‡è¿˜æ˜¯0%ï¼Œä¸ºäº†æ¼”ç¤ºè‡ªåŠ¨æ‰©ç¼©å®¹çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€äº›è¯·æ±‚æ¥å¢åŠ CPUä½¿ç”¨ç‡ã€‚é¦–å…ˆæˆ‘ä»¬åœ¨æ–°çš„çª—å£ä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒåŠ¨æ€çš„è§‚å¯Ÿhpaï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa backend-express-demo --watch</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener external nofollow noreferrer" href="https://busybox.net/">busybox</a>é•œåƒæ¥æ¨¡æ‹Ÿè¯·æ±‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -i --tty load-generator --rm --image=busybox:1.28 --restart=Never -- /bin/sh -c &quot;while sleep 0.01; do wget -q -O- http://backend-express-demo:4000; done&quot;</span><br></pre></td></tr></table></figure>
<p>è¯·æ±‚ä¸€æ®µæ—¶é—´åï¼ŒæŸ¥çœ‹hpaèµ„æºçš„å˜åŒ–ï¼Œå¯ä»¥çœ‹åˆ°CPUçš„ä½¿ç”¨ç‡è¾¾åˆ°5%åpodæ•°é‡ï¼ˆREPLICASåˆ—ï¼‰é€æ­¥å¢åŠ ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME                   REFERENCE                         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   0%/5%     2         10        2          15s</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   4%/5%     2         10        2          30s</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   11%/5%    2         10        2          90s</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   11%/5%    2         10        4          105s</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   11%/5%    2         10        5          2m</span><br><span class="line">backend-express-demo   Deployment/backend-express-demo   5%/5%     2         10        5          2m30s</span><br></pre></td></tr></table></figure>
<p>é™¤äº†é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼åˆ›å»ºHPAï¼Œè¿˜å¯ä»¥ä½¿ç”¨yamlæ–‡ä»¶çš„æ–¹å¼åˆ›å»ºï¼Œä¸Šé¢çš„HPAæ”¹æˆyamlæ–‡ä»¶åå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-express-demo</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: backend-express-demo</span><br><span class="line">  minReplicas: 2</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  targetCPUUtilizationPercentage: 5</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯ä»¥åˆ›å»ºHPAï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f ./hpa.yaml</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æŒ‡æ ‡ç§°ä¸ºèµ„æºæŒ‡æ ‡ï¼ˆresource metricsï¼‰å¹¶ä¸”CPUçš„ä½¿ç”¨ç‡ä¸º5%ï¼Œè¿˜æœ‰å¯ä»¥ä½¿ç”¨ç»å¯¹å€¼å’Œå…¶ä»–ç±»å‹çš„èµ„æºæŒ‡æ ‡ã€‚å…·ä½“å¯ä»¥<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">å‚è€ƒè¿™é‡Œ</a>ã€‚</p>
<h2 id="æ¢é’ˆï¼ˆProbesï¼‰"><a href="#æ¢é’ˆï¼ˆProbesï¼‰" class="headerlink" title="æ¢é’ˆï¼ˆProbesï¼‰"></a>æ¢é’ˆï¼ˆProbesï¼‰</h2><p>k8sä½¿ç”¨æ¢é’ˆæœºåˆ¶æ¥æ£€æŸ¥podå†…åº”ç”¨å¥åº·çŠ¶æ€ï¼Œæ¯”å¦‚nodejsåº”ç”¨è¿›ç¨‹å·²ç»ç”±äºå¼‚å¸¸å·²ç»åœæ­¢è¿è¡Œï¼Œæ­¤æ—¶éœ€è¦ä¸€ç§æœºåˆ¶æ¥æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯ç”¨ï¼Œå½“æ¢é’ˆæ£€æŸ¥å¤±è´¥æ—¶ï¼Œå¯ä»¥é”€æ¯è¯¥podå¹¶åˆ›æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„podæ¥ä¿æŒåº”ç”¨å§‹ç»ˆå¥åº·å¯ç”¨ã€‚k8sçš„æ¢é’ˆä¸»è¦åˆ†ä¸ºlivenessæ¢é’ˆã€startupæ¢é’ˆå’Œreadinessæ¢é’ˆã€‚åˆšåˆšä»‹ç»çš„æ˜¯livenessæ¢é’ˆã€‚</p>
<h3 id="liveness"><a href="#liveness" class="headerlink" title="liveness"></a>liveness</h3><p>å…ˆæ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨livenessæ¢é’ˆã€‚é¦–å…ˆåœ¨åº”ç”¨å†…åˆ›å»ºä¸€ä¸ªæ–°çš„è·¯ç”±ï¼Œä¿®æ”¹app.jsï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// æ·»åŠ http livenessæ¢é’ˆ</span><br><span class="line">app.get(&#x27;/healthz&#x27;,  (req, res) =&gt; &#123;</span><br><span class="line">  res.status(200);</span><br><span class="line">  console.log(`health check, $&#123;podname&#125; is ok`);</span><br><span class="line">  res.send(`$&#123;podname&#125; is ok`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">  startTime = new Date();</span><br><span class="line">  console.log(`Example app listening on port $&#123;port&#125; at $&#123;startTime&#125; | Running On: $&#123;podname&#125;\n`);</span><br><span class="line">  // 10såç»“æŸè¿›ç¨‹ï¼Œæ¨¡æ‹Ÿåº”ç”¨å¤±è´¥å…³é—­</span><br><span class="line">  setTimeout(() =&gt; &#123;</span><br><span class="line">    process.exit(1);</span><br><span class="line">  &#125;, 10000);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>æ‰“åŒ…é•œåƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t backend-express-demo:v3 .</span><br></pre></td></tr></table></figure>
<p>æ›´æ–°åº”ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployments/backend-express-demo backend-express-demo=backend-express-demo:v3</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¿®æ”¹depoyment-service.yamlæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: backend-express-demo</span><br><span class="line">  labels: </span><br><span class="line">    app: backend-express-demo</span><br><span class="line">    role: backend</span><br><span class="line">    env: test</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: backend-express-demo</span><br><span class="line">  replicas: 2    </span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: backend-express-demo</span><br><span class="line">        role: backend</span><br><span class="line">        env: test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: backend-express-demo</span><br><span class="line">        image: backend-express-demo:v2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 4000</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 4000</span><br><span class="line">            httpHeaders:</span><br><span class="line">            - name: Custom-Header</span><br><span class="line">              value: k8s-liveness-probes</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 3</span><br></pre></td></tr></table></figure>
<p>å¢åŠ <code>livenessProbe</code>é…ç½®é¡¹ã€‚ä¿®æ”¹yamlæ–‡ä»¶ä¹‹åå¯ä»¥é‡æ–°åº”ç”¨è¯¥å˜æ›´ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f depoyment-service.yaml</span><br></pre></td></tr></table></figure>
<p>ç„¶åå¯ä»¥è¿›å…¥k8s dashboardä¸­æŸ¥çœ‹eventsäº‹ä»¶ã€‚k8sçš„livenessæ¢é’ˆæ£€æµ‹å¤±è´¥ä¹‹åï¼Œpodè¢«æ€æ­»ï¼Œç„¶ååˆ›å»ºæ–°çš„podæ¥å¯åŠ¨åº”ç”¨ã€‚<br><img src="/%E5%AD%A6%E4%B9%A0/Kubernetes%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89/post4.png" alt="post4.png"></p>
<p>ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨çš„httpç±»å‹çš„æ¢é’ˆï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å‘å®¹å™¨å‘é€ä¹Ÿå®šçš„http getè¯·æ±‚ï¼Œå½“è¯·æ±‚çš„è¿”å›çŠ¶æ€ç &gt;=200å¹¶&lt;400æ—¶ï¼Œæ£€æµ‹ç»“æœæˆåŠŸï¼Œå¦åˆ™æ£€æµ‹å¤±è´¥ã€‚k8sè¿˜æœ‰å…¶ä»–ç±»å‹çš„æ¢é’ˆå¦‚commandã€tcpã€gRPCï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">å‚è€ƒè¿™é‡Œ</a>ã€‚</p>
<h3 id="startupæ¢é’ˆ"><a href="#startupæ¢é’ˆ" class="headerlink" title="startupæ¢é’ˆ"></a>startupæ¢é’ˆ</h3><p>æœ‰äº›åº”ç”¨å¯åŠ¨å’Œåˆå§‹åŒ–è¿‡ç¨‹è¾ƒé•¿ï¼Œæ­¤æ—¶livenessæ¢é’ˆæ£€æµ‹å¯èƒ½ä¼šå¤„äºå¤±è´¥çŠ¶æ€ï¼Œå¦‚æœk8såˆ é™¤äº†podå¹¶åˆ›å»ºæ–°çš„podï¼Œåº”ç”¨åˆä¼šé‡æ–°å¯åŠ¨ã€‚ä¸ºäº†é¿å…è¿™ç§æ­»é”çš„çŠ¶æ€ï¼Œk8sæä¾›äº†startupæ¢é’ˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: 4000</span><br><span class="line">    httpHeaders:</span><br><span class="line">    - name: Custom-Header</span><br><span class="line">      value: k8s-liveness-probes</span><br><span class="line">    initialDelaySeconds: 3</span><br><span class="line">    periodSeconds: 3        </span><br><span class="line">startupProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">    path: /healthz</span><br><span class="line">    port: 4000</span><br><span class="line">  failureThreshold: 30</span><br><span class="line">  periodSeconds: 10  </span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šé…ç½®æŒ‡ç¤ºåº”ç”¨ä¼šæœ‰10 * 30=300sçš„æ—¶é—´æ¥å®Œæˆå¯åŠ¨ï¼Œåªæœ‰å½“startupæ¢é’ˆçš„æ£€æµ‹ç»“æœæˆåŠŸï¼Œlivenessæ¢é’ˆæ‰ä¼šå¼€å§‹å·¥ä½œã€‚å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œ300ç§’ä¹‹åå®¹å™¨ä¼šè¢«æ€æ­»ï¼Œå¹¶å¯åŠ¨æ–°çš„podã€‚</p>
<h3 id="readiness"><a href="#readiness" class="headerlink" title="readiness"></a>readiness</h3><p>æœ‰æ—¶å€™åº”ç”¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”±äºæŸç§åŸå› å¯èƒ½ä¼šä¸´æ—¶å¤„äºä¸å¯ç”¨çŠ¶æ€ï¼Œå¦‚åº”ç”¨åŠ è½½å¤§çš„æ•°æ®æˆ–è€…é…ç½®æ–‡ä»¶æˆ–è€…ä¾èµ–å…¶ä»–å¤–éƒ¨çš„æœåŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨readinessæ¢é’ˆä½¿åº”ç”¨ä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œä¸”ä¸æ¥å—å¤–éƒ¨æµé‡è¯·æ±‚ã€‚readinessæ¢é’ˆçš„ä½¿ç”¨æ–¹å¼å’Œlivenesså®Œå…¨ç›¸åŒã€‚éœ€è¦æ³¨æ„çš„æ˜¯readinessè¿è¡Œåœ¨åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸æ˜¯å¯åŠ¨æ—¶ï¼Œè¿™åŒºåˆ«äºstartupæ¢é’ˆã€‚å¦å¤–livenessæ¢é’ˆä¸ä¼šç­‰å¾…readinessæ¢é’ˆçš„æ‰§è¡Œç»“æœï¼Œå®ƒåªä¼šç­‰å¾…startupæ¢é’ˆçš„æ‰§è¡Œç»“æœã€‚æœ‰å…³æ¢é’ˆçš„å…¶ä»–è¯¦ç»†ç”¨æ³•<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">å‚è€ƒè¿™é‡Œ</a>ã€‚</p>
<p>ä»¥ä¸Šä»£ç æ¼”ç¤ºåœ°å€<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/neilning-xc/kubernetes-demo">ç‚¹å‡»è¿™é‡Œ</a>ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://okigiveup.net/tutorials/a-tutorial-introduction-to-kubernetes/">https://okigiveup.net/tutorials/a-tutorial-introduction-to-kubernetes/</a></li>
</ul>


                

                <ul class="pager">
                    
                        <li class="previous"><a href="/å­¦ä¹ /ä½¿ç”¨é¢„æ¸²æŸ“-Prerender-æŠ€æœ¯åŠ é€Ÿé¡µé¢å¯¼èˆª.html">&larr;  ä¸Šä¸€ç¯‡</a></li>
                    
                    
                        <li class="next"><a href="/å­¦ä¹ /Web-Push-Notificationæ•™ç¨‹ï¼ˆäºŒï¼‰.html">ä¸‹ä¸€ç¯‡ &rarr;</a></li>
                    
                </ul>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/neilning-xc" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="mailto:ningcoder@foxmail.com" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 Neil Ning<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/" rel="external nofollow noreferrer">Clean Blog</a> from <a href="http://startbootstrap.com/" rel="external nofollow noreferrer" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer">Hexo</a> by <a href="http://www.codeblocq.com/" rel="external nofollow noreferrer" target="_blank">Jonathan Klughertz</a></p>
                <!-- <p class="copyright text-muted"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.miitbeian.gov.cn/">è±«ICPå¤‡19003046å·</a></p> -->
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//lib.baomitu.com/jquery/2.1.4/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="//lib.baomitu.com/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>