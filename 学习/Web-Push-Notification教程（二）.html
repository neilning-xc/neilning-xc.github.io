<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="Tell the world with code"/>
    

    <!--Author-->
    
        <meta name="author" content="Neil Ning"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Web Push Notificationæ•™ç¨‹ï¼ˆäºŒï¼‰"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Tell the world with code"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Neilçš„åšå®¢"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="https://neilning-xc.github.io/img/banner.jpg"/>
    

    <!-- Title -->
    
    <title>Web Push Notificationæ•™ç¨‹ï¼ˆäºŒï¼‰ - Neilçš„åšå®¢</title>

    <!-- Bootstrap Core CSS -->
    <link href="//lib.baomitu.com/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.css" rel="stylesheet"/>

    <!-- Google Analytics -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPEMLKFYYW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-ZPEMLKFYYW');
    </script>



    <!-- favicon -->
    

<meta name="generator" content="Hexo 5.4.2"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Neilçš„åšå®¢</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                é¦–é¡µ
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                å½’æ¡£
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                æ ‡ç­¾
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                åˆ†ç±»
                            
                        </a>
                    </li>
                
                    <li>
                        <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/neilning-xc/neilning-xc.github.io">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header post-header" style="background-image: url('Web-Push-Notificationæ•™ç¨‹ï¼ˆäºŒï¼‰/bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Web Push Notificationæ•™ç¨‹ï¼ˆäºŒï¼‰</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Neil Ning on
                        
                        
                            2023-08-22
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/web-push/">#web push</a> <a href="/tags/push-notification/">#push notification</a> <a href="/tags/service-worker/">#service worker</a> <a href="/tags/web-subscription/">#web subscription</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/å­¦ä¹ /">å­¦ä¹ </a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="å®Œå–„è®¢é˜…æ¨é€æµç¨‹"><a href="#å®Œå–„è®¢é˜…æ¨é€æµç¨‹" class="headerlink" title="å®Œå–„è®¢é˜…æ¨é€æµç¨‹"></a>å®Œå–„è®¢é˜…æ¨é€æµç¨‹</h2><p>å‰é¢å·²ç»åŸºæœ¬å®Œæˆäº†Webæ¨é€çš„åŸºç¡€æµç¨‹ï¼Œè¿˜æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦å¤„ç†ã€‚</p>
<h3 id="è·å–è®¢é˜…çŠ¶æ€"><a href="#è·å–è®¢é˜…çŠ¶æ€" class="headerlink" title="è·å–è®¢é˜…çŠ¶æ€"></a>è·å–è®¢é˜…çŠ¶æ€</h3><p>é¦–å…ˆç”¨æˆ·è®¢é˜…ä¹‹åï¼Œå†æ¬¡åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ‰“å¼€é¡µé¢æ—¶ï¼Œéœ€è¦é»˜è®¤å°†è®¢é˜…çŠ¶æ€è®¾ä¸ºå‹¾é€‰çŠ¶æ€ã€‚é€šè¿‡<code>serviceWorkerRegistration.pushManager.getSubscription()</code>è·å–åˆ°å½“å‰è®¾å¤‡çš„è®¢é˜…å¯¹è±¡ä¹‹åï¼Œè¿˜éœ€è¦å‘æœåŠ¡ç«¯æŸ¥è¯¢è¯¥è®¢é˜…å¯¹è±¡æ˜¯å¦è¿˜æœ‰æ•ˆï¼Œä¿®æ”¹frontend/index.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">async function checkSubscription(serviceWorkerRegistration) &#123;</span><br><span class="line">  const subscription = await serviceWorkerRegistration.pushManager.getSubscription();</span><br><span class="line">  if (subscription === null) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  const &#123; data &#125; = await getSubscription(subscription);</span><br><span class="line">  if (data.success &amp;&amp; data.id) &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getSubscription(subscription) &#123;</span><br><span class="line">  return fetch(&#x27;http://localhost:4000/api/get-subscription/&#x27;, &#123;</span><br><span class="line">    method: &#x27;POST&#x27;,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    body: JSON.stringify(subscription),</span><br><span class="line">  &#125;)</span><br><span class="line">    .then(function (response) &#123;</span><br><span class="line">      if (!response.ok) &#123;</span><br><span class="line">        throw new Error(&#x27;Bad status code from server.&#x27;);</span><br><span class="line">      &#125;</span><br><span class="line">      return response.json();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨backend/index.jsä¸­æ·»åŠ è·¯ç”±</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.post(&#x27;/api/get-subscription/&#x27;, async (req, res) =&gt; &#123;</span><br><span class="line">  const subscription = req.body;</span><br><span class="line">  const doc = await findSubscription(subscription.endpoint);</span><br><span class="line">  if (doc) &#123;</span><br><span class="line">    res.status(201);</span><br><span class="line">    res.json(&#123;data: &#123;success: true, id: doc._id&#125;&#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    res.status(201);</span><br><span class="line">    res.json(&#123;data: &#123;success: true&#125;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="å–æ¶ˆè®¢é˜…"><a href="#å–æ¶ˆè®¢é˜…" class="headerlink" title="å–æ¶ˆè®¢é˜…"></a>å–æ¶ˆè®¢é˜…</h3><p>æˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ å–æ¶ˆè®¢é˜…çš„åŠŸèƒ½ï¼Œå½“å–æ¶ˆå‹¾é€‰åï¼Œéœ€è¦è°ƒç”¨<code>subscription.unsubscribe()</code>å–æ¶ˆè®¢é˜…ï¼Œå¹¶åˆ é™¤è®¢é˜…å¯¹è±¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// frontend/index.js</span><br><span class="line">subscribeCheckbox.addEventListener(&#x27;input&#x27;, async (event) =&gt; &#123;</span><br><span class="line">    const checked = event.target.checked;</span><br><span class="line">    if (!checked) &#123;</span><br><span class="line">      // å–æ¶ˆè®¢é˜…</span><br><span class="line">      const subscription = await serviceWorkerRegistration.pushManager.getSubscription();</span><br><span class="line">      if (subscription) &#123;</span><br><span class="line">        await removeSubscription(subscription);</span><br><span class="line">        subscription.unsubscribe();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // è®¢é˜…</span><br><span class="line">      await askPermission();</span><br><span class="line">      const sub = await subscribeUserToPush(serviceWorkerRegistration);</span><br><span class="line">      sendSubscriptionToBackEnd(sub)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// backend/index.js</span><br><span class="line">app.post(&#x27;/api/remove-subscription/&#x27;, async (req, res) =&gt; &#123;</span><br><span class="line">  const subscription = req.body;</span><br><span class="line">  await removeSubscription(subscription);</span><br><span class="line">  res.status(200);</span><br><span class="line">  res.json(&#123;data: &#123; success: true &#125;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">function removeSubscription(endpoint) &#123;</span><br><span class="line">  return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    db.remove(&#123; endpoint &#125;, &#123;&#125;, function (err, numRemoved) &#123;</span><br><span class="line">      if (err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(numRemoved);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¢é˜…æˆåŠŸä¸ŠæŠ¥"><a href="#è®¢é˜…æˆåŠŸä¸ŠæŠ¥" class="headerlink" title="è®¢é˜…æˆåŠŸä¸ŠæŠ¥"></a>è®¢é˜…æˆåŠŸä¸ŠæŠ¥</h3><p>æ¥ä¸‹æ¥å®Œå–„å‰é¢é—ç•™çš„è®¢é˜…ä¸ŠæŠ¥çš„æµç¨‹ï¼Œä¿®æ”¹frontend/service-worker.js:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">async function reportNotify(notification) &#123;</span><br><span class="line">  const subscription = await self.registration.pushManager.getSubscription();</span><br><span class="line">  return fetch(&#x27;http://localhost:4000/api/report-push&#x27;, &#123;</span><br><span class="line">    method: &#x27;POST&#x27;,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    body: JSON.stringify(&#123; notification, subscription &#125;),</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;push&#x27;, (event) =&gt; &#123;</span><br><span class="line">  const notification = event.data.json();</span><br><span class="line">  const notifyPromise = self.registration.showNotification(</span><br><span class="line">    notification.title, </span><br><span class="line">    notification</span><br><span class="line">  );</span><br><span class="line">  // ä¸ŠæŠ¥æ¨é€æˆåŠŸäº‹ä»¶</span><br><span class="line">  const reportPromise = reportNotify(notification);</span><br><span class="line">  const promiseChain = Promise.all([reportPromise, notifyPromise]);</span><br><span class="line">  // ä»¥ä¸Šä¸¤ä¸ªpromiseéƒ½æˆåŠŸæ—¶ï¼Œservice workeræ‰ä¼šæ‰§è¡Œç»“æŸ</span><br><span class="line">  event.waitUntil(promiseChain);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>åœ¨backend/index.jsä¸­æ·»åŠ <code>/api/report-push</code>è·¯ç”±ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.post(&#x27;/api/report-push&#x27;, async (req, res) =&gt; &#123;</span><br><span class="line">  const notify = req.body;</span><br><span class="line">  console.log(notify);</span><br><span class="line">  res.json(&#123; data: &#123; success: true &#125; &#125;);</span><br><span class="line">  return;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="é€šçŸ¥æ¡†é€‰é¡¹"><a href="#é€šçŸ¥æ¡†é€‰é¡¹" class="headerlink" title="é€šçŸ¥æ¡†é€‰é¡¹"></a>é€šçŸ¥æ¡†é€‰é¡¹</h2><p>å‰é¢çš„service workerä»£ç ä¸­ï¼Œè°ƒç”¨<code>registration.showNotification()</code>æ—¶ï¼Œæˆ‘ä»¬åªæ˜¯ä¼ å…¥äº†é€šçŸ¥çš„titleå’Œbodyã€‚è¿˜æœ‰å…¶ä»–é€‰é¡¹å¯ä»¥å®šåˆ¶é€šçŸ¥æ¡†çš„å¤–è§‚å’Œè¡Œä¸ºã€‚è¯¥æ–¹æ³•æ‰€æ”¯æŒçš„æ‰€æœ‰é€‰é¡¹å¯ä»¥åœ¨<a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification">è¿™é‡ŒæŸ¥çœ‹</a>ã€‚</p>
<h3 id="iconå’Œbadge"><a href="#iconå’Œbadge" class="headerlink" title="iconå’Œbadge"></a>iconå’Œbadge</h3><p>é€šçŸ¥æ¡†å¯ä»¥è‡ªå®šä¹‰iconå’Œbadge(åªæœ‰Androidçš„Chromeæ”¯æŒbadgeé€‰é¡¹)ï¼Œä¿®æ”¹frontend/service-worker.js.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;push&#x27;, (event) =&gt; &#123;</span><br><span class="line">  const notification = event.data.json();</span><br><span class="line">  const &#123; title, body &#125; = notification;</span><br><span class="line">  const option = &#123;</span><br><span class="line">    body,</span><br><span class="line">    icon: &#x27;/images/dog.jpg&#x27;,</span><br><span class="line">    badge: &#x27;/images//badge.png&#x27;</span><br><span class="line">  &#125;</span><br><span class="line">  const notifyPromise = self.registration.showNotification(</span><br><span class="line">    title, </span><br><span class="line">    option</span><br><span class="line">  );</span><br><span class="line">  // ä¸ŠæŠ¥æ¨é€æˆåŠŸäº‹ä»¶</span><br><span class="line">  const reportPromise = reportNotify(notification);</span><br><span class="line">  const promiseChain = Promise.all([reportPromise, notifyPromise]);</span><br><span class="line">  // ä»¥ä¸Šä¸¤ä¸ªpromiseéƒ½æˆåŠŸæ—¶ï¼Œservice workeræ‰ä¼šæ‰§è¡Œç»“æŸ</span><br><span class="line">  event.waitUntil(promiseChain);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š<br><img src="/%E5%AD%A6%E4%B9%A0/Web-Push-Notification%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89/icon.png" alt="icon.png"></p>
<h3 id="actions"><a href="#actions" class="headerlink" title="actions"></a>actions</h3><p>é€šçŸ¥è¿˜æ”¯æŒactionsé€‰é¡¹ï¼ˆè¯¥é€‰é¡¹å¤„äºè¯•éªŒé˜¶æ®µï¼Œå¤§å¤šæ•°å¹³å°è¿˜ä¸æ”¯æŒï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const actions = [</span><br><span class="line">    &#123;</span><br><span class="line">      action: &#x27;coffee-action&#x27;,</span><br><span class="line">      type: &#x27;button&#x27;,</span><br><span class="line">      title: &#x27;Coffee&#x27;,</span><br><span class="line">      icon: &#x27;/images/coffee-action.png&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      action: &#x27;book-action&#x27;,</span><br><span class="line">      type: &#x27;button&#x27;,</span><br><span class="line">      title: &#x27;Book&#x27;,</span><br><span class="line">      icon: &#x27;/images/book-action.png&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line">  const option = &#123;</span><br><span class="line">    body,</span><br><span class="line">    icon: &#x27;/images/dog.jpg&#x27;,</span><br><span class="line">    badge: &#x27;/images/badge.png&#x27;,</span><br><span class="line">    actions</span><br><span class="line">  &#125;;</span><br><span class="line">  const notifyPromise = self.registration.showNotification(</span><br><span class="line">    title, </span><br><span class="line">    option</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p>æµè§ˆå™¨æ‰€æ”¯æŒçš„æœ€å¤§actionsæ•°é‡å¯ä»¥å¯ä»¥é€šè¿‡<code>window.Notification?.maxActions</code>æŸ¥çœ‹ã€‚<br>actionè¿˜æ”¯æŒå¿«æ·å›å¤é€‰é¡¹ï¼Œé€šè¿‡å°†actionçš„typeå±æ€§è®¾ç½®ä¸º<code>text</code>æ¥å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const actions = [</span><br><span class="line">    &#123;</span><br><span class="line">      action: &#x27;book-action&#x27;,</span><br><span class="line">      type: &#x27;text&#x27;,</span><br><span class="line">      title: &#x27;Book&#x27;,</span><br><span class="line">      icon: &#x27;/images/book-action.png&#x27;,</span><br><span class="line">      placeholder: &#x27;Type text here&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line">  const option = &#123;</span><br><span class="line">    body,</span><br><span class="line">    icon: &#x27;/images/dog.jpg&#x27;,</span><br><span class="line">    badge: &#x27;/images//badge.png&#x27;,</span><br><span class="line">    actions</span><br><span class="line">  &#125;;</span><br><span class="line">  const notifyPromise = self.registration.showNotification(</span><br><span class="line">    title, </span><br><span class="line">    option</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç placeholderä¼šä¿®æ”¹æ–‡æœ¬è¾“å…¥æ¡†çš„é—®é¢˜æç¤ºã€‚</p>
<h2 id="ç‚¹å‡»é€šçŸ¥æ¡†"><a href="#ç‚¹å‡»é€šçŸ¥æ¡†" class="headerlink" title="ç‚¹å‡»é€šçŸ¥æ¡†"></a>ç‚¹å‡»é€šçŸ¥æ¡†</h2><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç‚¹å‡»é€šçŸ¥æ¡†ä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿï¼Œæ¯”è¾ƒå¸¸è§çš„åšæ³•æ˜¯ç‚¹å‡»é€šçŸ¥æ¡†æ—¶æ‰“å¼€æŸä¸ªé¡µé¢å¹¶å…³é—­é€šçŸ¥ã€‚é€šçŸ¥æ¡†çš„ç‚¹å‡»äº‹ä»¶å¯ä»¥æ·»åŠ <code>&#39;notificationclick&#39;</code>äº‹ä»¶ç›‘å¬å™¨ã€‚ç”¨æˆ·ç‚¹å‡»é€šçŸ¥æ¡†æ—¶ï¼Œå¯ä»¥ç‚¹å‡»ä¸Šæ–‡çš„actionæŒ‰é’®æˆ–è€…ç‚¹å‡»æ•´ä¸ªé€šçŸ¥æ¡†ï¼Œå…ˆçœ‹å¦‚ä½•å¤„ç†actionçš„ç‚¹å‡»äº‹ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function handleActionClick(event) &#123;</span><br><span class="line">  switch (event.action) &#123;</span><br><span class="line">    case &#x27;coffee-action&#x27;:</span><br><span class="line">      console.log(&quot;User â¤ï¸ï¸&#x27;s coffee.&quot;);</span><br><span class="line">      break;</span><br><span class="line">    case &#x27;book-action&#x27;:</span><br><span class="line">      console.log(&quot;User â¤ï¸ï¸&#x27;s book.&quot;);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      console.log(`Unknown action clicked: &#x27;$&#123;event.action&#125;&#x27;`);</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;notificationclick&#x27;, (event) =&gt; &#123;</span><br><span class="line">  const clickedNotification = event.notification;</span><br><span class="line">  const &#123; data &#125; = clickedNotification;</span><br><span class="line">  handleActionClick(event);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°é€šè¿‡event.actionå¯ä»¥è·å–åˆ°ç‚¹å‡»çš„actionæŒ‰é’®ï¼Œä»–çš„å€¼å°±æ˜¯æˆ‘ä»¬å®šä¹‰actionsé€‰é¡¹æ—¶çš„actionå­—æ®µçš„å€¼ã€‚<br>å¦‚æœç”¨æˆ·ç‚¹å‡»äº†æ•´ä¸ªé€šçŸ¥æ¡†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¸®ç”¨æˆ·æ‰“å¼€æŸä¸ªé¡µé¢ï¼Œå¦‚æœé¡µé¢å·²ç»æ‰“å¼€ï¼Œåˆ™å°†å½“å‰ç„¦ç‚¹èšç„¦åˆ°ç›®æ ‡é¡µé¢ä¸Šï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç å³å¯å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;push&#x27;, (event) =&gt; &#123;</span><br><span class="line">  const notification = event.data.json();</span><br><span class="line">  const &#123; title, body &#125; = notification;</span><br><span class="line">  const actions = [</span><br><span class="line">    &#123;</span><br><span class="line">      action: &#x27;coffee-action&#x27;,</span><br><span class="line">      type: &#x27;button&#x27;,</span><br><span class="line">      title: &#x27;Coffee&#x27;,</span><br><span class="line">      icon: &#x27;/images/coffee-action.png&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      action: &#x27;book-action&#x27;,</span><br><span class="line">      type: &#x27;text&#x27;,</span><br><span class="line">      title: &#x27;Book&#x27;,</span><br><span class="line">      icon: &#x27;/images/book-action.png&#x27;,</span><br><span class="line">      placeholder: &#x27;Type text here&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line">  const option = &#123;</span><br><span class="line">    body,</span><br><span class="line">    icon: &#x27;/images/dog.jpg&#x27;,</span><br><span class="line">    badge: &#x27;/images/badge.png&#x27;,</span><br><span class="line">    actions,</span><br><span class="line">    vibrate: [</span><br><span class="line">      500, 110, 500, 110, 450, 110, 200, 110, 170, 40, 450, 110, 200, 110, 170,</span><br><span class="line">      40, 500,</span><br><span class="line">    ],</span><br><span class="line">    sound: &#x27;/sound/msg-sound.wav&#x27;,</span><br><span class="line">    timestamp: new Date().getTime(),</span><br><span class="line">    data: &#123;</span><br><span class="line">      msgUrl: &#x27;/detail.html&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  console.log(&quot;ğŸš€ ~ file: service-worker.js:66 ~ self.addEventListener ~ option:&quot;, option);</span><br><span class="line">  const notifyPromise = self.registration.showNotification(</span><br><span class="line">    title, </span><br><span class="line">    option</span><br><span class="line">  );</span><br><span class="line">  // ä¸ŠæŠ¥æ¨é€æˆåŠŸäº‹ä»¶</span><br><span class="line">  const reportPromise = reportNotify(notification);</span><br><span class="line">  const promiseChain = Promise.all([reportPromise, notifyPromise]);</span><br><span class="line">  // ä»¥ä¸Šä¸¤ä¸ªpromiseéƒ½æˆåŠŸæ—¶ï¼Œservice workeræ‰ä¼šæ‰§è¡Œç»“æŸ</span><br><span class="line">  event.waitUntil(promiseChain);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;notificationclick&#x27;, (event) =&gt; &#123;</span><br><span class="line">  const clickedNotification = event.notification;</span><br><span class="line">  const &#123; data &#125; = clickedNotification;</span><br><span class="line">  const msgUrl = data.msgUrl;</span><br><span class="line">  handleActionClick(event);</span><br><span class="line"></span><br><span class="line">  const urlToOpen = new URL(msgUrl, self.location.origin).href;</span><br><span class="line"></span><br><span class="line">  const promiseChain = clients</span><br><span class="line">    .matchAll(&#123;</span><br><span class="line">      type: &#x27;window&#x27;,</span><br><span class="line">      includeUncontrolled: true,</span><br><span class="line">    &#125;)</span><br><span class="line">    .then((windowClients) =&gt; &#123;</span><br><span class="line">      let matchingClient = null;</span><br><span class="line">      for (let i = 0; i &lt; windowClients.length; i++) &#123;</span><br><span class="line">        const windowClient = windowClients[i];</span><br><span class="line">        if (windowClient.url === urlToOpen) &#123;</span><br><span class="line">          matchingClient = windowClient;</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (matchingClient) &#123;</span><br><span class="line">        return matchingClient.focus();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return clients.openWindow(urlToOpen);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).then(() =&gt; &#123;</span><br><span class="line">      return clickedNotification.close();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  const reportPromise = reportClick();</span><br><span class="line">  event.waitUntil(Promise.all([reportPromise, promiseChain]));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡åœ¨optionä¸Šçš„dataå±æ€§æ¥æ·»åŠ è‡ªå®šä¹‰çš„æ•°æ®ï¼Œåœ¨clickäº‹ä»¶å›è°ƒä¸­é€šè¿‡clickedNotification.dataè·å–åˆ°éœ€è¦æ‰“å¼€çš„é¡µé¢çš„ç›¸å¯¹URLï¼Œé€šè¿‡<code>new URL(msgUrl, self.location.origin).href;</code>å°†å…¶è½¬æ¢ä¸ºç»å¯¹URLï¼Œç„¶åè°ƒç”¨<code>clients.matchAll()</code>è·å–åˆ°å½“å‰æ‰“å¼€çš„é¡µé¢ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ä¼ ç»™matchAllæ–¹æ³•çš„ä¸¤ä¸ªå±æ€§<code>type: &#39;window&#39;</code>è¡¨ç¤ºåŒ¹é…çš„æ˜¯w indowç±»å‹çš„å®¢æˆ·ç«¯ï¼Œ<code>includeUncontrolled: true</code>è¡¨ç¤ºæŸ¥æ‰¾æ‰€æœ‰åŒåŸŸçš„é¡µé¢ï¼Œå³ä½¿è¯¥é¡µé¢æ²¡æœ‰è¢«å½“å‰çš„service workeræ¥ç®¡ï¼Œè¯¥APIçš„è¯¦ç»†ä¿¡æ¯<a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Clients/matchAll">å‚è€ƒè¿™é‡Œ</a>ï¼Œç„¶åé€šè¿‡matchingClient.focus()æ¥èšç„¦å·²ç»æ‰“å¼€çš„é¡µé¢æˆ–è€…è°ƒç”¨clients.openWindow(urlToOpen)æ‰“å¼€æ–°çš„é¡µé¢ã€‚</p>
<blockquote>
<p>ä»¥ä¸Šä»£ç åŒæ—¶å±•ç¤ºäº†optionçš„å…¶ä»–é€‰é¡¹ï¼š<code>vibrate</code>ã€ <code>sound</code>ã€<code>timestamp</code>ã€‚è¿™äº›é€‰é¡¹å¤§å¤šæ•°è¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œå…¶ä¸­vibrateç”¨äºæŒ‡å®šé€šçŸ¥æ¡†çš„æŠ–åŠ¨è¡Œä¸ºï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œæ•°ç»„çš„0ï¼Œ2ï¼Œ4â€¦ç­‰å¶æ•°ç´¢å¼•æŒ‡çš„æ˜¯æŠ–åŠ¨çš„æ¯«ç§’æ•°ã€‚soundæŒ‡å¾—æ˜¯æ¶ˆæ¯æç¤ºéŸ³</p>
</blockquote>
<h2 id="å…³é—­é€šçŸ¥æ¡†äº‹ä»¶"><a href="#å…³é—­é€šçŸ¥æ¡†äº‹ä»¶" class="headerlink" title="å…³é—­é€šçŸ¥æ¡†äº‹ä»¶"></a>å…³é—­é€šçŸ¥æ¡†äº‹ä»¶</h2><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨ç”¨æˆ·ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­é€šçŸ¥æ¡†æ—¶ï¼Œä¸ŠæŠ¥ç”¨æˆ·çš„ç‚¹å‡»è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬<code>notificationclose</code>äº‹ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;notificationclose&#x27;, function (event) &#123;</span><br><span class="line">  const dismissedNotification = event.notification;</span><br><span class="line">  console.log(&quot;ğŸš€ ~ file: service-worker.js:90 ~ dismissedNotification:&quot;, dismissedNotification);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


<h2 id="åˆå¹¶é€šçŸ¥"><a href="#åˆå¹¶é€šçŸ¥" class="headerlink" title="åˆå¹¶é€šçŸ¥"></a>åˆå¹¶é€šçŸ¥</h2><p>å¦‚æœçŸ­æ—¶é—´å†…æœ‰å¤šæ¡é€šçŸ¥ï¼Œä¾‹å¦‚èŠå¤©ç±»åº”ç”¨ï¼Œå¯ä»¥åˆå¹¶å¤šæ¡é€šçŸ¥ï¼Œä»¥é¿å…æ˜¾ç¤ºå¤šæ¡é€šçŸ¥æ‰“æ‰°ç”¨æˆ·ã€‚é€šè¿‡<code>registration.getNotifications()</code>è·å–æ‰€æœ‰æœªå…³é—­ï¼ˆè°ƒç”¨<code>clickedNotification.close()</code>å…³é—­ï¼‰çš„é€šçŸ¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">function mergeNotification(notification) &#123;</span><br><span class="line">  // å½“å‰æ¨é€æ•°æ®</span><br><span class="line">  const &#123; userName, body &#125; = notification;</span><br><span class="line">  const promiseChain = self.registration.getNotifications().then((notifications) =&gt; &#123;</span><br><span class="line">    console.log(&quot;ğŸš€ ~ file: service-worker.js:76 ~ promiseChain ~ notifications:&quot;, notifications);</span><br><span class="line">    let currentNotification;</span><br><span class="line">    for (let i = 0; i &lt; notifications.length; i++) &#123;</span><br><span class="line">      if (notifications[i].data &amp;&amp; notifications[i].data.userName === userName) &#123;</span><br><span class="line">        currentNotification = notifications[i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // currentNotificationæŒ‡å¾—æ˜¯è€çš„æœªå…³é—­çš„é€šçŸ¥</span><br><span class="line">    return currentNotification;</span><br><span class="line">  &#125;).then((currentNotification) =&gt; &#123;</span><br><span class="line">    let notificationTitle;</span><br><span class="line">    const options = &#123;</span><br><span class="line">      icon: &#x27;/images/dog.jpg&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">    if (currentNotification) &#123;</span><br><span class="line">      const messageCount = currentNotification.data.newMessageCount + 1;</span><br><span class="line">      options.body = `You have $&#123;messageCount&#125; new messages from $&#123;userName&#125;.`;</span><br><span class="line">      options.data = &#123;</span><br><span class="line">        userName: userName,</span><br><span class="line">        newMessageCount: messageCount</span><br><span class="line">      &#125;;</span><br><span class="line">      notificationTitle = `New Messages from $&#123;userName&#125;`;</span><br><span class="line">  </span><br><span class="line">      // Remember to close the old notification.</span><br><span class="line">      currentNotification.close();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      options.body = `&quot;$&#123;body&#125;&quot;`;</span><br><span class="line">      options.data = &#123;</span><br><span class="line">        userName: userName,</span><br><span class="line">        newMessageCount: 1</span><br><span class="line">      &#125;;</span><br><span class="line">      notificationTitle = `New Message from $&#123;userName&#125;`;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    return self.registration.showNotification(</span><br><span class="line">      notificationTitle,</span><br><span class="line">      options</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">  return promiseChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·å‘é€æ¶ˆæ¯ï¼Œå°†ç›¸åŒç”¨æˆ·åå‘é€çš„æ¶ˆæ¯è¿›è¡Œåˆå¹¶ï¼Œä»£ç å…ˆæŸ¥æ‰¾ç›¸åŒç”¨æˆ·å‘é€çš„æœªå…³é—­çš„é€šçŸ¥ï¼Œå¦‚æœæ‰¾åˆ°ä¿®æ”¹é€šçŸ¥çš„titleå’Œbodyï¼Œå¹¶è°ƒç”¨<code>currentNotification.close()</code>ï¼Œå¦‚æœæœªæ‰¾åˆ°ï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºå½“å‰æ¨é€æ¶ˆæ¯ã€‚</p>
<h2 id="å¤„ç†ç‰¹æ®Šåœºæ™¯"><a href="#å¤„ç†ç‰¹æ®Šåœºæ™¯" class="headerlink" title="å¤„ç†ç‰¹æ®Šåœºæ™¯"></a>å¤„ç†ç‰¹æ®Šåœºæ™¯</h2><p>æŸäº›æ—¶å€™ï¼Œå½“ç”¨æˆ·æ­£åœ¨æµè§ˆç½‘ç«™æ—¶ï¼Œå¯ä»¥ä¸æ˜¾ç¤ºé€šçŸ¥æ¡†ï¼Œæˆ–è€…å°†è¯¥æ¨é€æ¶ˆæ¯å‘é€è‡³é¡µé¢å¹¶æ›´æ–°é¡µé¢ï¼Œä¾‹å¦‚èŠå¤©ç±»åº”ç”¨ã€‚å½“ç”¨æˆ·æ­£åœ¨èŠå¤©æ—¶ï¼Œæ–°æ¶ˆæ¯æŠµè¾¾æ—¶ç›´æ¥æ›´æ–°èŠå¤©ç•Œé¢å³å¯ï¼Œæ— éœ€æ˜¾ç¤ºæ¨é€æ¶ˆæ¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function isClientFocused() &#123;</span><br><span class="line">  return clients</span><br><span class="line">    .matchAll(&#123;</span><br><span class="line">      type: &#x27;window&#x27;,</span><br><span class="line">      includeUncontrolled: true,</span><br><span class="line">    &#125;)</span><br><span class="line">    .then((windowClients) =&gt; &#123;</span><br><span class="line">      let clientIsFocused = false;</span><br><span class="line"></span><br><span class="line">      for (let i = 0; i &lt; windowClients.length; i++) &#123;</span><br><span class="line">        const windowClient = windowClients[i];</span><br><span class="line">        if (windowClient.focused) &#123;</span><br><span class="line">          clientIsFocused = true;</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return clientIsFocused;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç é€šè¿‡<code>windowClient.focused</code>åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰åŒåŸŸçª—å£æ­£åœ¨æ‰“å¼€ã€‚<br>ç„¶ååœ¨<code>push</code>å›è°ƒå‡½æ•°ä¸­è°ƒç”¨è¯¥å‡½æ•°æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºé€šçŸ¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const promiseChain = isClientFocused().then((clientIsFocused) =&gt; &#123;</span><br><span class="line">  if (clientIsFocused) &#123;</span><br><span class="line">    console.log(&quot;Don&#x27;t need to show a notification.&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Client isn&#x27;t focused, we need to show a notification.</span><br><span class="line">  return self.registration.showNotification(&#x27;Had to show a notification.&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">event.waitUntil(promiseChain);</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…é€šè¿‡åœ¨service workerä¸­è°ƒç”¨<code>windowClient.postMessage</code>å°†æ¶ˆæ¯é€šè¿‡postMessageå‘é€ç»™ä¸»çº¿ç¨‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const promiseChain = isClientFocused().then((clientIsFocused) =&gt; &#123;</span><br><span class="line">  if (clientIsFocused) &#123;</span><br><span class="line">    windowClients.forEach((windowClient) =&gt; &#123;</span><br><span class="line">      windowClient.postMessage(&#123;</span><br><span class="line">        message: &#x27;Received a push message.&#x27;,</span><br><span class="line">        time: new Date().toString(),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return self.registration.showNotification(&#x27;No focused windows&#x27;, &#123;</span><br><span class="line">      body: &#x27;Had to show a notification instead of messaging each page.&#x27;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">event.waitUntil(promiseChain);</span><br></pre></td></tr></table></figure>
<p>åœ¨index.jsä¸­å¯ä»¥æ¥å—service workerçº¿ç¨‹å‘ä¸»çº¿ç¨‹å‘é€çš„æ¶ˆæ¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">navigator.serviceWorker.addEventListener(&#x27;message&#x27;, function (event) &#123;</span><br><span class="line">  console.log(&#x27;Received a message from service worker: &#x27;, event.data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šdemoçš„å®Œæ•´ä»£ç <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/neilning-xc/push-notification-demo">ç‚¹å‡»è¿™é‡Œ</a>ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://web.dev/notifications/">https://web.dev/notifications/</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification">https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification</a></li>
</ul>


                

                <ul class="pager">
                    
                        <li class="previous"><a href="/å­¦ä¹ /Kuberneteså…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰.html">&larr;  ä¸Šä¸€ç¯‡</a></li>
                    
                    
                        <li class="next"><a href="/å­¦ä¹ /Web-Push-Notificationæ•™ç¨‹ï¼ˆä¸€ï¼‰.html">ä¸‹ä¸€ç¯‡ &rarr;</a></li>
                    
                </ul>
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/neilning-xc" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="mailto:ningcoder@foxmail.com" rel="external nofollow noreferrer" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2025 Neil Ning<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/" rel="external nofollow noreferrer">Clean Blog</a> from <a href="http://startbootstrap.com/" rel="external nofollow noreferrer" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer">Hexo</a> by <a href="http://www.codeblocq.com/" rel="external nofollow noreferrer" target="_blank">Jonathan Klughertz</a></p>
                <!-- <p class="copyright text-muted"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.miitbeian.gov.cn/">è±«ICPå¤‡19003046å·</a></p> -->
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//lib.baomitu.com/jquery/2.1.4/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="//lib.baomitu.com/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//lib.baomitu.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>